<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rad IA 2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            updateProfile, // Needed for display name
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBOrzU01DWanKV6YbvdCX-IJqmJY-zS808",
            authDomain: "gemini-api-609db.firebaseapp.com",
            projectId: "gemini-api-609db",
            storageBucket: "gemini-api-609db.firebasestorage.app",
            messagingSenderId: "582858271153",
            appId: "1:582858271153:web:0f3c79fa6f856f83d1f590",
            measurementId: "G-P2SF9FTF85"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const auth = getAuth(app);
            console.log("Firebase initialized successfully.");

            window.firebaseServices = {
                app,
                auth,
                signInWithEmailAndPassword,
                createUserWithEmailAndPassword,
                sendPasswordResetEmail,
                updateProfile,
                onAuthStateChanged,
                signOut,
                analytics
            };
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = "Erro crítico ao inicializar os serviços de autenticação. A aplicação pode não funcionar corretamente.";
                errorElement.style.display = 'block';
            } else {
                alert("Erro crítico ao inicializar o Firebase. A aplicação pode não funcionar corretamente.");
            }
        }
    </script>

    <style>
        :root {
            --primary-red: #e50914;
            --dark-background: #141414;
            --medium-dark-background: #1f1f1f;
            --light-text: #ffffff;
            --medium-gray-text: #b3b3b3;
            --dark-gray-text: #808080;
            --btn-green: #4CAF50;
            --btn-green-hover: #45a049;
            --btn-blue: #2196F3;
            --btn-blue-hover: #1e88e5;
            --btn-pink: #E91E63;
            --btn-pink-hover: #d81b60;
            --btn-red: #f44336;
            --btn-red-hover: #e53935;
            --btn-yellow: #FFEB3B;
            --btn-yellow-hover: #fdd835;
            --btn-yellow-text: #333333;
            --accent-color-1: #f5a623;
            --accent-color-2: #bd10e0;
            --accent-color-3: #7ed321;
            --accent-color-5: #e91e63;
            --accent-color-6: #00bcd4;
            --accent-color-8: #009688;
            --accent-color-9: #ff5722;
            --accent-color-10: #607d8b;
            --border-color: #303030;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0;
            background-color: var(--dark-background);
            color: var(--light-text);
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .top-bar {
            background-color: #000000;
            color: var(--light-text);
            padding: 10px 20px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .top-bar-user-info {
            color: var(--medium-gray-text);
            font-size: 0.9em;
            margin-right: 15px;
            display: none;
        }
        .top-bar-buttons {
            display: flex;
            align-items: center;
        }

        .top-bar .main-title {
            color: var(--primary-red);
            margin: 0;
            font-size: 1.6em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #mainMenuButton, #btnLogout {
            border: 1px solid var(--btn-blue);
            color: var(--btn-blue);
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: none;
        }
        #mainMenuButton:hover, #btnLogout:hover {
            background-color: var(--btn-blue);
            color: var(--light-text);
        }
        #mainMenuButton .fa-solid, #btnLogout .fa-solid {
            margin-right: 8px;
        }
        #btnLogout {
            margin-left: 10px;
            border-color: var(--btn-red);
            color: var(--btn-red);
        }
        #btnLogout:hover {
            background-color: var(--btn-red);
            color: var(--light-text);
        }


        .side-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.3s ease-in-out;
            padding-top: 60px;
            box-shadow: 3px 0px 10px rgba(0,0,0,0.5);
        }
        .side-menu a {
            padding: 10px 15px 10px 25px;
            text-decoration: none;
            font-size: 1.0em;
            color: var(--medium-gray-text);
            display: block;
            transition: 0.3s;
            white-space: nowrap;
        }
        .side-menu a:hover, .side-menu a.active {
            color: var(--primary-red);
            background-color: #222;
        }
        .side-menu .close-btn {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
            color: var(--light-text);
            cursor: pointer;
        }
        .side-menu a .fa-solid {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content-area {
            width: 100%;
            max-width: 960px;
            padding: 20px;
            box-sizing: border-box;
            margin-top: 80px;
            transition: opacity 0.3s ease-in-out; /* Apenas opacidade para o container principal */
            display: none;
            opacity: 0;
        }
        .main-content-area.visible {
            display: block;
            opacity: 1;
        }


        .generator-section {
            background-color: var(--medium-dark-background);
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 20px var(--shadow-color);
            margin-bottom: 30px;
            text-align: left;
            border: 1px solid var(--border-color);
            /* Controle de visibilidade e transição */
            display: none; /* Começa escondido */
            opacity: 0;
            transition: opacity 0.3s ease-in-out; /* Transição apenas na opacidade */
        }
        .generator-section.active {
            display: block; /* Torna visível */
            opacity: 1;
        }


        .generator-section h2 {
            color: var(--light-text);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .generator-section h2 .fa-solid {
            font-size: 0.9em;
            color: var(--primary-red);
        }
        .generator-section h3 {
            color: var(--medium-gray-text);
            font-size: 1.1em;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        .checkbox-group {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .checkbox-group label {
            margin-right: 15px;
            color: var(--medium-gray-text);
            font-size: 0.9em;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
            accent-color: var(--primary-red);
        }
        .text-options-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .text-options-group .form-group {
            flex: 1;
            min-width: 150px;
        }


        #aiGeneratedImageContainer {
            margin-top: 15px;
            padding: 10px;
            border: 2px dashed var(--dark-gray-text);
            border-radius: 8px;
            background-color: var(--dark-background);
            min-height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #aiGeneratedImage {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            object-fit: contain;
        }
        #aiImagePlaceholder {
            color: var(--medium-gray-text);
            font-size: 0.9em;
        }

        .button-group {
            margin-top: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            color: var(--light-text);
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Cores dos Botões de Funcionalidades */
        #btnProcessFileToSpeech, #btnExportPodcastScriptPdf { background-color: var(--btn-green); }
        #btnProcessFileToSpeech:hover, #btnExportPodcastScriptPdf:hover { background-color: var(--btn-green-hover); }

        #btnGenerateSpeechFromText, #btnPlayScript, #btnPlayTranslatedText, #btnPlayRecipe { background-color: var(--btn-pink); }
        #btnGenerateSpeechFromText:hover, #btnPlayScript:hover, #btnPlayTranslatedText:hover, #btnPlayRecipe:hover { background-color: var(--btn-pink-hover); }

        #btnGenerateImageFromText, #btnDownloadAiImage, #btnDeleteAiImage { background-color: var(--btn-blue); }
        #btnGenerateImageFromText:hover, #btnDownloadAiImage:hover, #btnDeleteAiImage:hover { background-color: var(--btn-blue-hover); }

        #btnGenerateScript { background-color: var(--btn-yellow); color: var(--btn-yellow-text); }
        #btnGenerateScript:hover { background-color: var(--btn-yellow-hover); }

        #btnTranslateText { background-color: var(--accent-color-8); } /* Teal */
        #btnTranslateText:hover { background-color: #00796b; }

        #btnGenerateActivity, #btnExportActivityPdf, #btnGenerateProof, #btnExportProofPdf { background-color: var(--accent-color-6); } /* Ciano */
        #btnGenerateActivity:hover, #btnExportActivityPdf:hover, #btnGenerateProof:hover, #btnExportProofPdf:hover { background-color: #00a1b3; }

        #btnGenerateSlide, #btnExportSlidePdf, #btnExportSlidePptx { background-color: var(--accent-color-9); } /* Deep Orange */
        #btnGenerateSlide:hover, #btnExportSlidePdf:hover, #btnExportSlidePptx:hover { background-color: #e64a19; }

        #btnGenerateReport, #btnExportReportPdf { background-color: var(--accent-color-10); } /* Blue Grey */
        #btnGenerateReport:hover, #btnExportReportPdf:hover { background-color: #546e7a; }

        #btnSendChatMessage { background-color: var(--btn-blue); }
        #btnSendChatMessage:hover { background-color: var(--btn-blue-hover); }
        #btnUpdateUsername { background-color: var(--btn-green); }
        #btnUpdateUsername:hover { background-color: var(--btn-green-hover); }
        #btnGenerateLessonPlan, #btnExportLessonPlanPdf, #btnVerifySubject, #btnExportSubjectVerificationPdf { background-color: var(--btn-pink); }
        #btnGenerateLessonPlan:hover, #btnExportLessonPlanPdf:hover, #btnVerifySubject:hover, #btnExportSubjectVerificationPdf:hover { background-color: var(--btn-pink-hover); }


        #errorMessage {
            color: #f8d7da;
            font-weight: 500;
            margin: 20px auto;
            padding: 12px 18px;
            border-radius: 6px;
            background-color: #721c24;
            border: 1px solid #f5c6cb;
            text-align: left;
            display: none;
            max-width: 900px;
        }
        .loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            color: var(--light-text);
            font-size: 1.2em;
            text-align: center;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }
        .loading-indicator i {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
            animation: fa-spin 1.2s infinite linear;
        }
        .loading-indicator p {
            margin: 0;
            font-weight: 500;
        }

        textarea, select, input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid var(--dark-gray-text);
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            min-height: 40px;
            box-sizing: border-box;
            background-color: #2b2b2b;
            color: var(--light-text);
        }
        textarea {
            min-height: 70px;
            resize: vertical;
        }
        textarea::placeholder {
            color: var(--medium-gray-text);
        }
        input[type="file"] {
            margin-top: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid var(--dark-gray-text);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            width: 100%;
            box-sizing: border-box;
            background-color: #2b2b2b;
            color: var(--light-text);
        }
        input[type="file"]::file-selector-button {
            background-color: var(--btn-red);
            color: var(--light-text);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: var(--btn-red-hover);
        }

        #audioPlayerContainer, #voiceChatResponseContainer, #scriptDisplayContainer,
        #activityDisplayContainer, #searchResultsContainer, #translatedTextContainer,
        #slideContentContainer, #reportContentContainer, #ideasDisplayContainer, #recipeDisplayContainer,
        #podcastScriptDisplayContainer, #lessonPlanDisplayContainer, #subjectVerificationDisplayContainer, #proofDisplayContainer {
            margin-top: 20px;
            text-align: center;
        }
        audio {
            width: 100%;
            max-width: 550px;
            border-radius: 6px;
        }
        #voiceChatResponseText, #generatedScriptText, #generatedActivityText,
        #searchResultsText, #translatedTextOutput, #generatedSlideContent,
        #generatedReportContent, #generatedIdeasText, #generatedRecipeText,
        #generatedPodcastScriptText, #generatedLessonPlanText, #verifiedSubjectText, #generatedProofText {
            background-color: #2b2b2b;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            text-align: left;
            white-space: pre-wrap;
            font-size: 0.95em;
            color: var(--light-text);
            border: 1px solid var(--border-color);
            max-height: 400px;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--medium-gray-text);
        }

        /* Auth Section Styles */
        #authSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-background);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
        }
        .auth-form-container {
            background-color: var(--medium-dark-background);
            padding: 30px 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-form-container h2 {
            color: var(--primary-red);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .auth-form-container label {
            display: block;
            text-align: left;
            color: var(--medium-gray-text);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .auth-form-container input[type="email"],
        .auth-form-container input[type="password"],
        .auth-form-container input[type="text"] {
            margin-bottom: 20px;
        }
        .auth-form-container button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1em;
            background-color: var(--btn-green);
        }
        .auth-form-container button:hover {
            background-color: var(--btn-green-hover);
        }
        .auth-error-message {
            color: #f8d7da;
            background-color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
            text-align: left;
            font-size: 0.9em;
        }
        .toggle-form-link, .forgot-password-link {
            display: block;
            margin-top: 15px;
            color: var(--medium-gray-text);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9em;
        }
        .toggle-form-link:hover, .forgot-password-link:hover {
            color: var(--light-text);
        }
        #signUpForm, #forgotPasswordForm {
            display: none;
        }
        .whatsapp-support {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #25D366;
            color: white;
            padding: 12px;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1002;
            transition: transform 0.2s ease-in-out;
            display: none;
        }
        .whatsapp-support:hover {
            transform: scale(1.1);
        }


        @media (max-width: 768px) {
            .top-bar {
                padding: 10px 15px;
            }
            .top-bar .main-title {
                font-size: 1.3em;
            }
            #mainMenuButton, #btnLogout {
                font-size: 0.8em;
                padding: 6px 10px;
            }
            .side-menu {
                padding-top: 50px;
            }
            .side-menu a {
                font-size: 1em;
                padding: 8px 10px 8px 20px;
            }
            .side-menu .close-btn {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
            .main-content-area {
                margin-top: 60px;
                padding: 15px 10px;
            }
            .generator-section h2 {
                font-size: 1.4em;
            }
            .button-group button {
                width: 100%;
                padding: 12px 15px;
            }
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
             .auth-form-container button {
                width: 100%;
            }
            textarea, select, input[type="file"], input[type="text"], input[type="email"], input[type="password"] {
                font-size: 0.9em;
            }
            .whatsapp-support {
                font-size: 20px;
                padding: 10px;
                bottom: 15px;
                right: 15px;
            }
            .text-options-group {
                flex-direction: column;
                gap: 0;
            }
            .text-options-group .form-group {
                 min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1 class="main-title">Rad IA 2.0</h1>
        <div class="top-bar-user-info" id="userInfo"></div>
        <div class="top-bar-buttons">
            <button id="mainMenuButton"><i class="fa-solid fa-bars"></i> RAD IA MENU</button>
            <button id="btnLogout"><i class="fa-solid fa-sign-out-alt"></i> SAIR</button>
        </div>
    </div>

    <div id="authSection">
        <div class="auth-form-container">
            <form id="loginForm">
                <h2>Login - Rad IA 2.0</h2>
                <div>
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div>
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" id="loginButton">Entrar</button>
                <div id="loginErrorMessage" class="auth-error-message"></div>
                <p class="toggle-form-link" id="showSignUpLink">Não tem uma conta? Cadastre-se aqui.</p>
                <p class="forgot-password-link" id="showForgotPasswordLink">Esqueceu sua senha?</p>
            </form>

            <form id="signUpForm">
                <h2>Criar Conta - Rad IA 2.0</h2>
                 <div>
                    <label for="signUpUsername">Nome de Usuário:</label>
                    <input type="text" id="signUpUsername" required>
                </div>
                <div>
                    <label for="signUpEmail">Email:</label>
                    <input type="email" id="signUpEmail" required>
                </div>
                <div>
                    <label for="signUpPassword">Senha (mínimo 6 caracteres):</label>
                    <input type="password" id="signUpPassword" required>
                </div>
                <div>
                    <label for="signUpConfirmPassword">Confirmar Senha:</label>
                    <input type="password" id="signUpConfirmPassword" required>
                </div>
                <button type="submit" id="signUpButton">Cadastrar</button>
                <div id="signUpErrorMessage" class="auth-error-message"></div>
                <p class="toggle-form-link" id="showLoginLinkFromSignUp">Já tem uma conta? Entre aqui.</p>
            </form>

            <form id="forgotPasswordForm">
                <h2>Redefinir Senha</h2>
                <p>Insira seu e-mail para enviarmos um link de redefinição de senha.</p>
                <div>
                    <label for="forgotPasswordEmail">Email:</label>
                    <input type="email" id="forgotPasswordEmail" required>
                </div>
                <button type="submit" id="forgotPasswordButton">Enviar Link</button>
                <div id="forgotPasswordMessage" class="auth-error-message" style="background-color: var(--btn-green); color: white;"></div>
                <p class="toggle-form-link" id="showLoginLinkFromForgotPassword">Voltar para o Login.</p>
            </form>
        </div>
    </div>


    <div id="sideMenu" class="side-menu">
        <a href="javascript:void(0)" class="close-btn" id="closeMenuButton">&times;</a>
        <a href="#" class="tool-link active" data-target="fileToPodcastSection"><i class="fa-solid fa-file-audio"></i> Podcast</a>
        <a href="#" class="tool-link" data-target="textToSpeechSection"><i class="fa-solid fa-comment-dots"></i> Texto-Fala</a>
        <a href="#" class="tool-link" data-target="imageGeneratorSection"><i class="fa-solid fa-image"></i> Imagem</a>
        <a href="#" class="tool-link" data-target="scriptGeneratorSection"><i class="fa-solid fa-scroll"></i> Guião</a>
        <a href="#" class="tool-link" data-target="translatorSection"><i class="fa-solid fa-language"></i> Tradutor</a>
        <a href="#" class="tool-link" data-target="activityGeneratorSection"><i class="fa-solid fa-graduation-cap"></i> Atividades</a>
        <a href="#" class="tool-link" data-target="slideGeneratorSection"><i class="fa-solid fa-person-chalkboard"></i> Slides</a>
        <a href="#" class="tool-link" data-target="reportGeneratorSection"><i class="fa-solid fa-file-signature"></i> Relatórios</a>
        <a href="#" class="tool-link" data-target="radimakChatSection"><i class="fa-solid fa-robot"></i> Radimak</a>
        <a href="#" class="tool-link" data-target="lessonPlanGeneratorSection"><i class="fa-solid fa-calendar-alt"></i> Planej. de Aula</a>
        <a href="#" class="tool-link" data-target="subjectVerifierSection"><i class="fa-solid fa-book-reader"></i> Verificar Assunto</a>
        <a href="#" class="tool-link" data-target="proofGeneratorSection"><i class="fa-solid fa-file-alt"></i> Gerador de Provas</a>
        <a href="#" class="tool-link" data-target="profileSection"><i class="fa-solid fa-user-pen"></i> Meu Perfil</a>
    </div>


    <div class="main-content-area" id="mainContentArea">
        <p id="errorMessage"></p>

        <div id="profileSection" class="generator-section">
            <h2><i class="fa-solid fa-user-circle"></i> Meu Perfil</h2>
            <div class="form-group">
                <label for="profileEmail">Email:</label>
                <input type="email" id="profileEmail" readonly style="background-color: #333; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="profileUsername">Nome de Usuário:</label>
                <input type="text" id="profileUsername">
            </div>
            <div class="button-group">
                <button id="btnUpdateUsername"><i class="fa-solid fa-save"></i> Salvar Nome</button>
            </div>
            <div id="profileUpdateMessage" class="auth-error-message" style="text-align:center;"></div>
        </div>


        <div id="fileToPodcastSection" class="generator-section active">
            <h2><i class="fa-solid fa-file-invoice"></i> Converter Ficheiro em Podcast (Diálogo)</h2>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/gif,image/webp,application/pdf,.txt">
            <div class="form-group">
                <label for="podcastSpeaker1Voice">Voz do Apresentador 1:</label>
                <select id="podcastSpeaker1Voice"></select>
            </div>
            <div class="form-group">
                <label for="podcastSpeaker2Voice">Voz do Apresentador 2:</label>
                <select id="podcastSpeaker2Voice"></select>
            </div>
            <div class="button-group">
                <button id="btnProcessFileToSpeech"><i class="fa-solid fa-podcast"></i> Gerar Diálogo em Áudio</button>
                <button id="btnExportPodcastScriptPdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar Guião para PDF</button>
            </div>
             <div id="podcastScriptDisplayContainer" style="display:none;">
                <h3>Guião do Podcast Gerado:</h3>
                <div id="generatedPodcastScriptText"></div>
            </div>
        </div>

        <div id="textToSpeechSection" class="generator-section">
            <h2><i class="fa-solid fa-align-left"></i> Gerador de Fala (Text-to-Speech)</h2>
            <textarea id="ttsInputText" placeholder="Escreva o texto que deseja converter em fala..."></textarea>
            <div class="form-group">
                <label for="ttsVoiceSelect">Escolha a Voz:</label>
                <select id="ttsVoiceSelect"></select>
            </div>
            <div class="button-group">
                <button id="btnGenerateSpeechFromText"><i class="fa-solid fa-volume-high"></i> Gerar Fala com IA (Texto)</button>
            </div>
        </div>

        <div id="audioPlayerContainer" style="display:none;">
            <audio id="audioPlayer" controls></audio>
        </div>

        <div id="imageGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-palette"></i> Criar Imagem com Inteligência Artificial</h2>
            <textarea id="imagePrompt" placeholder="Descreva a imagem que você quer gerar (ex: um gato astronauta a flutuar no espaço, pintura a óleo)"></textarea>
            <div class="button-group">
                <button id="btnGenerateImageFromText"><i class="fa-solid fa-wand-magic-sparkles"></i> Gerar Imagem com IA</button>
            </div>
            <div id="aiGeneratedImageContainer">
                <img id="aiGeneratedImage" src="#" alt="Imagem gerada por IA aparecerá aqui" style="display:none;"/>
                <span id="aiImagePlaceholder">A sua imagem gerada por IA aparecerá aqui.</span>
            </div>
            <div class="button-group">
                <button id="btnDownloadAiImage" style="display:none;"><i class="fa-solid fa-download"></i> Baixar Imagem da IA</button>
                <button id="btnDeleteAiImage" style="display:none;"><i class="fa-solid fa-trash-can"></i> Apagar Imagem da IA</button>
            </div>
        </div>

        <div id="scriptGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-feather-pointed"></i> Gerador de Guiões e Histórias</h2>
            <textarea id="scriptPrompt" placeholder="Descreva o tema, personagens, género ou ideia base para o seu guião ou história..."></textarea>
            <div class="text-options-group">
                <div class="form-group">
                    <label for="scriptTextSize">Tamanho do Texto:</label>
                    <select id="scriptTextSize">
                        <option value="médio" selected>Médio (padrão)</option>
                        <option value="pequeno">Pequeno</option>
                        <option value="grande">Grande</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scriptTextTone">Tom do Texto:</label>
                    <select id="scriptTextTone">
                        <option value="casual" selected>Casual (padrão)</option>
                        <option value="informal">Informal</option>
                        <option value="formal">Formal</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="scriptVoiceSelect">Voz para Narração:</label>
                <select id="scriptVoiceSelect"></select>
            </div>
            <div class="button-group">
                <button id="btnGenerateScript"><i class="fa-solid fa-book-open"></i> Gerar Guião/História</button>
            </div>
            <div id="scriptDisplayContainer" style="display:none;">
                <h3>Guião/História Gerada:</h3>
                <div id="generatedScriptText"></div>
                <div class="button-group">
                    <button id="btnPlayScript" style="display:none;"><i class="fa-solid fa-play-circle"></i> ✨ Ouvir Guião/História</button>
                </div>
            </div>
        </div>

        <div id="translatorSection" class="generator-section">
            <h2><i class="fa-solid fa-language"></i> Tradutor de Texto Inteligente</h2>
            <div class="form-group">
                <label for="sourceTextToTranslate">Texto para Traduzir:</label>
                <textarea id="sourceTextToTranslate" placeholder="Introduza o texto aqui..."></textarea>
            </div>
            <div class="form-group">
                <label for="sourceLanguageSelect">Língua de Origem:</label>
                <select id="sourceLanguageSelect">
                    <option value="auto">Detetar Automaticamente</option>
                    <option value="pt">Português</option> <option value="en">Inglês</option> <option value="es">Espanhol</option> <option value="fr">Francês</option> <option value="de">Alemão</option> <option value="it">Italiano</option> <option value="ja">Japonês</option> <option value="ko">Coreano</option> <option value="zh">Chinês (Simplificado)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="targetLanguageSelect">Língua de Destino:</label>
                <select id="targetLanguageSelect">
                    <option value="pt">Português</option> <option value="en" selected>Inglês</option> <option value="es">Espanhol</option> <option value="fr">Francês</option> <option value="de">Alemão</option> <option value="it">Italiano</option> <option value="ja">Japonês</option> <option value="ko">Coreano</option> <option value="zh">Chinês (Simplificado)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="translatorVoiceSelect">Voz para Tradução:</label>
                <select id="translatorVoiceSelect"></select>
            </div>
            <div class="button-group">
                <button id="btnTranslateText"><i class="fa-solid fa-exchange-alt"></i> Traduzir Texto</button>
            </div>
            <div id="translatedTextContainer" style="display:none;">
                <h3>Texto Traduzido:</h3>
                <div id="translatedTextOutput"></div>
                <div class="button-group">
                    <button id="btnPlayTranslatedText" style="display:none;"><i class="fa-solid fa-volume-up"></i> ✨ Ouvir Tradução</button>
                </div>
            </div>
        </div>

        <div id="activityGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-graduation-cap"></i> Gerador de Atividades Escolares</h2>
            <div class="form-group">
                <label for="activityYearSelect">Ano Escolar:</label>
                <select id="activityYearSelect">
                    </select>
            </div>
            <div class="form-group">
                <label for="activitySubjectSelect">Matéria:</label>
                <select id="activitySubjectSelect"> </select>
            </div>
            <div class="form-group">
                <label for="activitySpecificContentSelect">Conteúdo Específico:</label>
                 <select id="activitySpecificContentSelect"> </select>
            </div>
            <div class="text-options-group">
                <div class="form-group">
                    <label for="activityTextSize">Tamanho do Texto das Questões:</label>
                    <select id="activityTextSize">
                        <option value="médio" selected>Médio (padrão)</option>
                        <option value="pequeno">Pequeno</option>
                        <option value="grande">Grande</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="activityTextTone">Tom do Texto das Questões:</label>
                    <select id="activityTextTone">
                        <option value="formal" selected>Formal (padrão)</option>
                        <option value="casual">Casual</option>
                        <option value="informal">Informal</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="activityQuestionTypeSelect">Tipo de Questão:</label>
                 <select id="activityQuestionTypeSelect">
                    <option value="Ambas">Ambas (Objetivas e Subjetivas)</option>
                    <option value="Objetivas">Apenas Objetivas (ex: múltipla escolha, V/F)</option>
                    <option value="Subjetivas">Apenas Subjetivas (ex: dissertativas, problemas)</option>
                 </select>
            </div>
            <div class="form-group">
                <label for="activityNumQuestionsSelect">Número de Questões:</label>
                <select id="activityNumQuestionsSelect">
                    <option value="5">5 Questões</option> <option value="10">10 Questões</option> <option value="15">15 Questões</option>
                </select>
            </div>
            <div class="button-group">
                <button id="btnGenerateActivity"><i class="fa-solid fa-cogs"></i> Gerar Atividades</button>
            </div>
            <div id="activityDisplayContainer" style="display:none;">
                <h3>Atividades Geradas:</h3>
                <div id="generatedActivityText"></div>
                 <div class="button-group">
                    <button id="btnExportActivityPdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar Atividades para PDF</button>
                </div>
            </div>
        </div>

        <div id="slideGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-person-chalkboard"></i> Gerador de Slides</h2>
            <div class="form-group">
                <label for="slideTopicInput">Tema Principal dos Slides:</label>
                <textarea id="slideTopicInput" placeholder="Ex: A Revolução Francesa, O Ciclo da Água, Introdução à Álgebra..."></textarea>
            </div>
            <div class="text-options-group">
                <div class="form-group">
                    <label for="slideTextSize">Tamanho do Conteúdo do Slide:</label>
                    <select id="slideTextSize">
                        <option value="médio" selected>Médio (padrão)</option>
                        <option value="conciso">Conciso</option>
                        <option value="detalhado">Detalhado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="slideTextTone">Tom do Conteúdo do Slide:</label>
                    <select id="slideTextTone">
                        <option value="formal" selected>Formal (padrão)</option>
                        <option value="informativo">Informativo</option>
                        <option value="envolvente">Envolvente</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="slideNumSlidesInput">Número Aproximado de Slides:</label>
                <select id="slideNumSlidesInput">
                    <option value="5">5 Slides</option>
                    <option value="10" selected>10 Slides</option>
                    <option value="15">15 Slides</option>
                </select>
            </div>
             <div class="checkbox-group">
                <input type="checkbox" id="slideIncludeImagesCheckbox" checked>
                <label for="slideIncludeImagesCheckbox">Sugerir Imagens (a IA descreverá imagens relevantes)</label>
            </div>
            <div class="button-group">
                <button id="btnGenerateSlide"><i class="fa-solid fa-file-powerpoint"></i> Gerar Conteúdo dos Slides</button>
                 <button id="btnExportSlidePdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar para PDF</button>
                 <button id="btnExportSlidePptx" style="display:none;"><i class="fa-solid fa-file-powerpoint"></i> Exportar para PPTX</button>
            </div>
            <div id="slideContentContainer" style="display:none;">
                <h3>Conteúdo dos Slides Gerado:</h3>
                <div id="generatedSlideContent"></div>
            </div>
        </div>

        <div id="reportGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-file-signature"></i> Gerador de Relatórios</h2>
            <div class="form-group">
                <label for="reportTopicInput">Tema do Relatório:</label>
                <textarea id="reportTopicInput" placeholder="Ex: Impacto das Redes Sociais na Juventude, Fontes de Energia Renovável..."></textarea>
            </div>
             <div class="form-group">
                <label for="reportAuthorInput">Autor(es) (opcional):</label>
                <input type="text" id="reportAuthorInput" placeholder="Seu nome ou nomes dos autores">
            </div>
            <div class="text-options-group">
                <div class="form-group">
                    <label for="reportTextSize">Tamanho do Conteúdo:</label>
                    <select id="reportTextSize">
                        <option value="médio" selected>Médio (padrão)</option>
                        <option value="resumido">Resumido</option>
                        <option value="detalhado">Detalhado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportTextTone">Tom do Conteúdo:</label>
                    <select id="reportTextTone">
                        <option value="formal" selected>Formal (padrão)</option>
                        <option value="analítico">Analítico</option>
                        <option value="objetivo">Objetivo</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button id="btnGenerateReport"><i class="fa-solid fa-book-journal-whills"></i> Gerar Estrutura do Relatório</button>
                <button id="btnExportReportPdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar Relatório para PDF</button>
            </div>
            <div id="reportContentContainer" style="display:none;">
                <h3>Estrutura do Relatório Gerada:</h3>
                <div id="generatedReportContent"></div>
            </div>
        </div>

        <div id="radimakChatSection" class="generator-section">
            <h2><i class="fa-solid fa-robot"></i> Radimak Chat</h2>
            <div id="chatMessagesContainer" style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; background-color: var(--dark-background); border-radius: 6px;">
                </div>
            <textarea id="chatInput" placeholder="Escreva a sua dúvida ou mensagem para o Radimak..." style="min-height: 50px;"></textarea>
            <div class="button-group">
                <button id="btnSendChatMessage"><i class="fa-solid fa-paper-plane"></i> Enviar Mensagem</button>
            </div>
        </div>

        <div id="lessonPlanGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-calendar-alt"></i> Gerador de Planejamento de Aula</h2>
            <div class="form-group">
                <label for="lessonPlanYear">Ano/Série:</label>
                <select id="lessonPlanYear"></select> </div>
            <div class="form-group">
                <label for="lessonPlanSubject">Matéria:</label>
                <select id="lessonPlanSubject"></select> </div>
            <div class="form-group">
                <label for="lessonPlanContent">Conteúdo Específico:</label>
                <textarea id="lessonPlanContent" placeholder="Ex: Teorema de Pitágoras, Concordância Verbal, Revolução Francesa..."></textarea>
            </div>
            <div class="form-group">
                <label for="lessonPlanObjectives">Objetivos da Aula (separados por ponto e vírgula ";"):</label>
                <textarea id="lessonPlanObjectives" placeholder="Ex: Compreender o Teorema de Pitágoras; Aplicar o teorema em problemas práticos..."></textarea>
            </div>
             <div class="text-options-group">
                <div class="form-group">
                    <label for="lessonPlanDuration">Duração da Aula (ex: 50 min, 2 aulas):</label>
                    <input type="text" id="lessonPlanDuration" placeholder="Ex: 1 aula de 50 minutos">
                </div>
                <div class="form-group">
                    <label for="lessonPlanStyle">Estilo de Linguagem:</label>
                    <select id="lessonPlanStyle">
                        <option value="prática" selected>Prática</option>
                        <option value="teórica">Teórica</option>
                        <option value="lúdica">Lúdica</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lessonPlanSize">Tamanho do Planejamento:</label>
                    <select id="lessonPlanSize">
                        <option value="padrão" selected>Padrão</option>
                        <option value="resumido">Resumido</option>
                        <option value="detalhado">Detalhado</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button id="btnGenerateLessonPlan"><i class="fa-solid fa-cogs"></i> Gerar Planejamento</button>
                <button id="btnExportLessonPlanPdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar para PDF</button>
            </div>
            <div id="lessonPlanDisplayContainer" style="display:none;">
                <h3>Planejamento de Aula Gerado:</h3>
                <div id="generatedLessonPlanText"></div>
            </div>
        </div>

        <div id="subjectVerifierSection" class="generator-section">
            <h2><i class="fa-solid fa-book-reader"></i> Verificador de Assuntos</h2>
            <div class="form-group">
                <label for="verifySubjectYear">Ano/Série:</label>
                <select id="verifySubjectYear"></select> </div>
            <div class="form-group">
                <label for="verifySubjectSubject">Matéria:</label>
                <select id="verifySubjectSubject"></select> </div>
            <div class="form-group">
                <label for="verifySubjectContent">Conteúdo a Verificar:</label>
                <select id="verifySubjectContent"></select> </div>
            <div class="button-group">
                <button id="btnVerifySubject"><i class="fa-solid fa-search-plus"></i> Verificar Assunto</button>
                 <button id="btnExportSubjectVerificationPdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar para PDF</button>
            </div>
            <div id="subjectVerificationDisplayContainer" style="display:none;">
                <h3>Detalhes do Assunto:</h3>
                <div id="verifiedSubjectText"></div>
            </div>
        </div>

        <div id="proofGeneratorSection" class="generator-section">
            <h2><i class="fa-solid fa-file-alt"></i> Gerador de Provas</h2>
            <div class="form-group">
                <label for="proofInstitutionName">Nome da Instituição:</label>
                <input type="text" id="proofInstitutionName" placeholder="Ex: Centro Educacional Contemporâneo">
            </div>
            <div class="form-group">
                <label for="proofTeacherName">Nome do Professor(a):</label>
                <input type="text" id="proofTeacherName" placeholder="Ex: Prof. Kelvin Radimak">
            </div>
            <div class="form-group">
                <label for="proofYear">Ano/Série:</label>
                <select id="proofYear"></select> </div>
            <div class="form-group">
                <label for="proofSubject">Matéria:</label>
                <select id="proofSubject"></select> </div>
            <div class="form-group">
                <label for="proofContent">Conteúdo(s) da Prova (separados por vírgula ","):</label>
                <textarea id="proofContent" placeholder="Ex: Teorema de Pitágoras, Equações de 1º Grau"></textarea>
            </div>
            <div class="text-options-group">
                 <div class="form-group">
                    <label for="proofNumQuestions">Número de Questões:</label>
                    <select id="proofNumQuestions">
                        <option value="5" selected>5 Questões</option>
                        <option value="10">10 Questões</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="proofQuestionType">Tipo de Questões:</label>
                    <select id="proofQuestionType">
                        <option value="Ambas" selected>Ambas (Objetivas e Subjetivas)</option>
                        <option value="Objetivas">Apenas Objetivas</option>
                        <option value="Subjetivas">Apenas Subjetivas</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="proofHeaderImage">Enviar Cabeçalho (PNG - Opcional, funcionalidade futura):</label>
                <input type="file" id="proofHeaderImage" accept="image/png">
            </div>
            <div class="button-group">
                <button id="btnGenerateProof"><i class="fa-solid fa-file-signature"></i> Gerar Prova</button>
                <button id="btnExportProofPdf" style="display:none;"><i class="fa-solid fa-file-pdf"></i> Exportar para PDF</button>
                </div>
            <div id="proofDisplayContainer" style="display:none;">
                <h3>Prova Gerada:</h3>
                <div id="generatedProofText"></div>
            </div>
        </div>


        <div class="loading-indicator" id="loadingIndicator"><i class="fas fa-spinner"></i><p>Aguarde...</p></div>
    </div>
    <a href="https://wa.me/5579988115582" target="_blank" class="whatsapp-support" id="whatsappSupportLink" title="Suporte via WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script>
        // API Keys
        const userProvidedApiKey = "AIzaSyDxcxVmGPBbg7mJ6_cmMDkHrDpbx3Lspik";
        const geminiFlashApiKey = userProvidedApiKey;
        const imagenApiKey = userProvidedApiKey;
        const ttsApiKey = userProvidedApiKey;

        // Variáveis Globais
        let errorMessageElement, loadingIndicator, authSection, loginForm, loginEmailInput, loginPasswordInput, loginButton, loginErrorMessageElement;
        let signUpForm, signUpUsernameInput, signUpEmailInput, signUpPasswordInput, signUpConfirmPasswordInput, signUpButton, signUpErrorMessageElement;
        let forgotPasswordForm, forgotPasswordEmailInput, forgotPasswordButton, forgotPasswordMessageElement;
        let showSignUpLink, showLoginLinkFromSignUp, showForgotPasswordLink, showLoginLinkFromForgotPassword;
        let mainMenuButton, mainContentArea, btnLogout, userInfoDisplay, whatsappSupportLink;
        let profileSection, profileEmailDisplay, profileUsernameInput, btnUpdateUsername, profileUpdateMessage;

        let fileInput, btnProcessFileToSpeech, btnExportPodcastScriptPdf, podcastScriptDisplayContainer, generatedPodcastScriptText;
        let ttsInputText, btnGenerateSpeechFromText, audioPlayer, audioPlayerContainer;
        let imagePromptTextarea, btnGenerateImageFromText, aiGeneratedImageElement, aiImagePlaceholder, aiGeneratedImageContainer, btnDownloadAiImage, btnDeleteAiImage;
        let scriptPromptTextarea, btnGenerateScript, scriptDisplayContainer, generatedScriptText, btnPlayScript, scriptVoiceSelect, scriptTextSizeSelect, scriptTextToneSelect;
        let activityYearSelect, activitySubjectSelect, activitySpecificContentSelect, activityNumQuestionsSelect, btnGenerateActivity, activityDisplayContainer, generatedActivityText, btnExportActivityPdf, activityTextSizeSelect, activityTextToneSelect;
        let sourceTextToTranslate, sourceLanguageSelect, targetLanguageSelect, btnTranslateText, translatedTextContainer, translatedTextOutput, btnPlayTranslatedText, translatorVoiceSelect;
        let slideTopicInput, slideNumSlidesInput, slideIncludeImagesCheckbox, btnGenerateSlide, slideContentContainer, generatedSlideContent, btnExportSlidePdf, btnExportSlidePptx, slideTextSizeSelect, slideTextToneSelect;
        let reportTopicInput, reportAuthorInput, btnGenerateReport, reportContentContainer, generatedReportContent, btnExportReportPdf, reportTextSizeSelect, reportTextToneSelect;
        let chatInput, btnSendChatMessage, chatMessagesContainer;

        // Novas Funcionalidades
        let lessonPlanGeneratorSection, lessonPlanYearSelect, lessonPlanSubjectSelect, lessonPlanContentInput, lessonPlanObjectivesInput, lessonPlanDurationInput, lessonPlanStyleSelect, lessonPlanSizeSelect, btnGenerateLessonPlan, lessonPlanDisplayContainer, generatedLessonPlanText, btnExportLessonPlanPdf;
        let subjectVerifierSection, verifySubjectYearSelect, verifySubjectSubjectSelect, verifySubjectContentSelect, btnVerifySubject, subjectVerificationDisplayContainer, verifiedSubjectText, btnExportSubjectVerificationPdf;
        let proofGeneratorSection, proofInstitutionNameInput, proofTeacherNameInput, proofYearSelect, proofSubjectSelect, proofContentInput, proofNumQuestionsSelect, proofQuestionTypeSelect, proofHeaderImageInput, btnGenerateProof, proofDisplayContainer, generatedProofText, btnExportProofPdf;


        let mediaRecorder;
        let audioChunks = [];
        let lastAttemptedMimeType = '';

        const availableVoices = [
            { name: "Zephyr", value: "Zephyr" }, { name: "Puck", value: "Puck" },
            { name: "Charon", value: "Charon" }, { name: "Kore", value: "Kore" },
            { name: "Alnilam", value: "Alnilam" }, { name: "Sadachbia", value: "Sadachbia" },
            { name: "Leda", value: "Leda" }
        ];
        const conteudosPorMateriaAno = {
            "Matemática": {
                "6": ["Números Naturais e Operações Fundamentais", "Múltiplos e Divisores (MMC e MDC)", "Frações: Conceitos e Operações", "Números Decimais e Operações", "Porcentagem Básica", "Geometria: Figuras Planas e Sólidos Geométricos", "Medidas de Comprimento, Massa, Capacidade e Tempo", "Introdução à Álgebra (sentenças matemáticas)"],
                "7": ["Números Inteiros: Operações e Ordenação", "Números Racionais: Frações e Decimais (positivos e negativos)", "Equações de 1º Grau com uma Incógnita", "Sistemas de Equações de 1º Grau (método da substituição)", "Razão e Proporção", "Regra de Três Simples e Composta", "Porcentagem e Juros Simples", "Ângulos e suas Classificações, Ângulos Opostos pelo Vértice", "Polígonos: Classificação, Propriedades e Soma dos Ângulos Internos", "Área de Figuras Planas (quadrado, retângulo, triângulo, trapézio, losango, círculo)"],
                "8": ["Números Reais e Potenciação com Expoente Inteiro e Fracionário", "Radiciação e suas Propriedades", "Produtos Notáveis e Fatoração Algébrica", "Sistemas de Equações de 1º Grau com Duas Incógnitas (método da adição)", "Equações de 2º Grau Incompletas", "Teorema de Pitágoras e suas aplicações", "Semelhança de Triângulos e Teorema de Tales", "Volume de Prismas e Cilindros", "Estatística: Média, Moda e Mediana", "Noções de Probabilidade"],
                "9": ["Potenciação e Radiciação (revisão e aprofundamento)", "Função Afim (1º Grau): Gráfico, Coeficientes e Raiz", "Função Quadrática (2º Grau): Gráfico, Vértice e Raízes (Fórmula de Bhaskara)", "Equações de 2º Grau Completas", "Relações Métricas no Triângulo Retângulo (além de Pitágoras)", "Trigonometria no Triângulo Retângulo (seno, cosseno, tangente de 30º, 45º, 60º)", "Circunferência e Círculo: Comprimento e Área", "Semelhança de Figuras Geométricas (polígonos e sólidos)", "Juros Compostos", "Estatística: Desvio Padrão e Variância (introdução)"],
                "1EM": ["Conjuntos Numéricos (N, Z, Q, I, R)", "Funções: Conceito, Domínio, Imagem, Gráficos", "Função Afim e Linear", "Função Quadrática: Vértice, Raízes, Gráfico", "Função Modular", "Função Exponencial e Logarítmica (introdução)", "Progressões Aritméticas (PA) e Geométricas (PG)", "Matemática Financeira: Porcentagem, Juros Simples e Compostos (básico)"],
                "2EM": ["Trigonometria no Ciclo Trigonométrico", "Funções Trigonométricas (Seno, Cosseno, Tangente)", "Relações Trigonométricas Fundamentais e Derivadas", "Matrizes, Determinantes e Sistemas Lineares", "Análise Combinatória: Princípio Fundamental da Contagem, Arranjos, Permutações, Combinações", "Probabilidade (básica e condicional)"],
                "3EM": ["Geometria Analítica: Ponto, Reta, Circunferência", "Números Complexos: Forma Algébrica e Trigonométrica", "Polinômios e Equações Algébricas", "Estatística: Medidas de Tendência Central, Medidas de Dispersão, Gráficos", "Noções de Limite e Derivada (introdução, se aplicável ao currículo)"]
            },
            "Português": {
                "6": ["Interpretação de Textos Diversos", "Gêneros: Conto, Fábula, Notícia, Poema", "Substantivos", "Adjetivos", "Artigos", "Pronomes Pessoais", "Verbos (Modo Indicativo)", "Ortografia Básica", "Pontuação"],
                "7": ["Interpretação Textual Avançada", "Gêneros: Crônica, Reportagem, Entrevista", "Pronomes (Possessivos, Demonstrativos, Indefinidos)", "Advérbios", "Preposições", "Conjunções Coordenativas", "Verbos (Modo Subjuntivo)", "Concordância Nominal"],
                "8": ["Análise Crítica de Textos", "Gêneros: Artigo de Opinião, Resenha, Texto Teatral", "Vozes Verbais", "Conjunções Subordinativas", "Período Composto (Coordenação e Subordinação)", "Concordância Verbal", "Regência (casos simples)"],
                "9": ["Análise de Discurso", "Gêneros: Editorial, Manifesto, Debate", "Funções da Linguagem", "Variação Linguística", "Sintaxe do Período Composto (aprofundamento)", "Pontuação Expressiva", "Intertextualidade", "Literatura Brasileira (movimentos iniciais)"],
                "1EM": ["Literatura: Trovadorismo, Humanismo, Classicismo", "Gêneros Literários: Lírico, Épico, Dramático", "Gramática: Classes de Palavras (revisão e aprofundamento)", "Sintaxe do Período Simples e Composto (revisão)", "Figuras de Linguagem", "Produção Textual: Dissertação (introdução)"],
                "2EM": ["Literatura: Barroco, Arcadismo, Romantismo no Brasil", "Análise Literária", "Gramática: Concordância Verbal e Nominal (casos especiais)", "Regência Verbal e Nominal", "Crase", "Produção Textual: Artigo de Opinião, Editorial"],
                "3EM": ["Literatura: Realismo/Naturalismo, Parnasianismo, Simbolismo, Pré-Modernismo e Modernismo no Brasil", "Interpretação de Textos Literários e Não Literários (ENEM)", "Estilística e Semântica", "Vanguardas Europeias", "Produção Textual: Resenha Crítica, Texto Dissertativo-Argumentativo (ENEM)"]
            },
            "Ciências": {
                "6": ["Universo e Sistema Solar", "Planeta Terra", "Água, Solo e Ar", "Seres Vivos (características, reinos)", "Cadeias Alimentares"],
                "7": ["Máquinas Simples", "Energia (fontes, transformações)", "Calor e Temperatura", "Som e Luz", "Ecossistemas Brasileiros", "Relações Ecológicas", "Impactos Ambientais"],
                "8": ["Corpo Humano (células, tecidos, órgãos, sistemas)", "Sistemas: Digestório, Respiratório, Circulatório, Excretor, Nervoso, Locomotor", "Reprodução Humana", "Saúde e Prevenção"],
                "9": ["Genética (hereditariedade, DNA)", "Evolução das Espécies", "Química (matéria, átomos, moléculas, tabela periódica - introdução)", "Misturas", "Reações Químicas (introdução)", "Física (movimento, força, Leis de Newton - introdução)"]
            },
            "Biologia": {
                "1EM": ["Origem da Vida e Evolução Celular", "Bioquímica: Água, Sais Minerais, Carboidratos, Lipídios, Proteínas, Vitaminas, Ácidos Nucleicos", "Citologia: Membrana Plasmática, Citoplasma, Organelas, Núcleo", "Divisão Celular: Mitose e Meiose", "Histologia Animal (tecidos básicos)"],
                "2EM": ["Seres Vivos: Classificação (Reinos Monera, Protista, Fungi, Plantae, Animalia)", "Vírus", "Fisiologia Vegetal (nutrição, transporte, hormônios)", "Zoologia dos Invertebrados e Vertebrados (principais grupos e características)", "Embriologia Animal"],
                "3EM": ["Genética Mendeliana e Pós-Mendeliana", "Engenharia Genética e Biotecnologia", "Evolução: Teorias Evolutivas, Especiação", "Ecologia: Populações, Comunidades, Ecossistemas, Biomas, Relações Ecológicas, Ciclos Biogeoquímicos", "Fisiologia Humana (sistemas de forma aprofundada)"]
            },
             "Física": {
                "1EM": ["Introdução à Física e Grandezas Físicas", "Cinemática Escalar: Movimento Uniforme, MUV, Queda Livre", "Cinemática Vetorial: Vetores, Movimento Circular Uniforme", "Dinâmica: Leis de Newton, Forças (Peso, Normal, Atrito, Elástica)", "Trabalho, Potência e Energia (Cinética, Potencial Gravitacional e Elástica)", "Conservação da Energia Mecânica"],
                "2EM": ["Termologia: Temperatura, Calor, Escalas Termométricas, Dilatação Térmica, Calorimetria, Mudanças de Fase, Gases Ideais, Termodinâmica (1ª e 2ª Leis)", "Óptica Geométrica: Princípios, Reflexão (espelhos planos e esféricos), Refração (lentes delgadas, lei de Snell)", "Ondulatória: Ondas (classificação, fenômenos), MHS, Acústica (qualidades do som, efeito Doppler)"],
                "3EM": ["Eletrostática: Carga Elétrica, Processos de Eletrização, Força Elétrica (Lei de Coulomb), Campo Elétrico, Potencial Elétrico, Capacitores", "Eletrodinâmica: Corrente Elétrica, Resistores (Lei de Ohm), Circuitos Elétricos (série, paralelo, misto), Potência e Energia Elétrica, Geradores e Receptores", "Eletromagnetismo: Campo Magnético, Força Magnética, Indução Eletromagnética (Lei de Faraday-Lenz), Ondas Eletromagnéticas"]
            },
            "Química": {
                "1EM": ["Matéria e Energia: Propriedades, Transformações", "Modelos Atômicos (Dalton, Thomson, Rutherford, Bohr)", "Estrutura Atômica: Partículas Fundamentais, Número Atômico e de Massa, Íons, Isótopos", "Tabela Periódica: Organização, Propriedades Periódicas", "Ligações Químicas: Iônica, Covalente, Metálica", "Geometria Molecular e Polaridade", "Funções Inorgânicas: Ácidos, Bases, Sais, Óxidos"],
                "2EM": ["Grandezas Químicas: Massa Atômica, Massa Molecular, Mol, Massa Molar", "Cálculos Estequiométricos: Leis Ponderais, Pureza, Rendimento", "Soluções: Classificação, Concentração (comum, molaridade, título, ppm)", "Termoquímica: Entalpia, Variação de Entalpia, Lei de Hess, Energia de Ligação", "Cinética Química: Velocidade das Reações, Fatores que Afetam a Velocidade, Energia de Ativação"],
                "3EM": ["Equilíbrio Químico: Constante de Equilíbrio (Kc, Kp), Deslocamento de Equilíbrio (Le Chatelier)", "Equilíbrio Iônico: pH, pOH, Hidrólise Salina, Soluções Tampão", "Eletroquímica: Pilhas, Eletrólise, Leis de Faraday", "Radioatividade: Emissões Alfa, Beta, Gama, Meia-vida, Fissão e Fusão Nuclear", "Química Orgânica: Introdução, Hidrocarbonetos (alcanos, alcenos, alcinos, cíclicos, aromáticos), Funções Oxigenadas (álcool, fenol, éter, aldeído, cetona, ácido carboxílico, éster), Funções Nitrogenadas (amina, amida)"]
            },
            "História": {
                "6": ["O que é História", "Pré-História", "Mesopotâmia e Egito", "Grécia Antiga", "Roma Antiga"],
                "7": ["Europa Feudal", "Império Bizantino e Islamismo", "Cruzadas", "Renascimento Comercial e Urbano", "Grandes Navegações", "Povos Indígenas da América"],
                "8": ["Iluminismo", "Revolução Francesa", "Revolução Industrial", "Independência dos EUA", "Período Napoleônico", "Independências na América Latina", "Brasil Imperial (1º Reinado, Regências)"],
                "9": ["Brasil Imperial (2º Reinado)", "República Velha no Brasil", "1ª Guerra Mundial", "Revolução Russa", "Crise de 1929", "2ª Guerra Mundial", "Guerra Fria"],
                "1EM": ["Antiguidade Oriental (Mesopotâmia, Egito, Hebreus, Fenícios, Persas)", "Antiguidade Clássica (Grécia e Roma - aprofundamento)", "Mundo Medieval (Feudalismo, Igreja, Cultura)", "Expansão Marítima Europeia e Colonização da América", "Renascimento Cultural e Reformas Religiosas"],
                "2EM": ["Absolutismo e Mercantilismo", "Revoluções Inglesas e Iluminismo", "Revolução Francesa e Era Napoleônica", "Independências na América Espanhola e Haitiana", "Brasil: Período Joanino, Independência, Primeiro Reinado e Período Regencial", "Segundo Reinado no Brasil"],
                "3EM": ["Imperialismo e Neocolonialismo no Século XIX", "Primeira Guerra Mundial", "Período Entreguerras (Crise de 29, Totalitarismos)", "Segunda Guerra Mundial", "Guerra Fria e Nova Ordem Mundial", "Brasil República: República Velha, Era Vargas, Período Democrático (1946-64), Ditadura Militar, Nova República", "História Contemporânea e Desafios Globais"]
            },
            "Geografia": {
                "6": ["Espaço Geográfico", "Orientação e Localização", "Cartografia", "Planeta Terra (movimentos, climas)", "Relevo, Hidrografia, Vegetação do Brasil", "População Brasileira"],
                "7": ["Formação Territorial do Brasil", "Regiões Brasileiras", "Urbanização Brasileira", "Atividades Econômicas no Brasil", "Recursos Naturais do Brasil"],
                "8": ["Globalização e Blocos Econômicos", "Continentes (América, África)", "Conflitos Mundiais", "Desenvolvimento e Subdesenvolvimento", "Questões Ambientais Globais"],
                "9": ["Europa (aspectos físicos, UE)", "Ásia (potências regionais)", "Oceania e Regiões Polares", "Redes Geográficas", "Brasil no Contexto Global"],
                "1EM": ["Introdução à Geografia e Pensamento Geográfico", "Cartografia (escalas, projeções, sensoriamento remoto)", "Geologia Geral e Relevo Terrestre", "Climatologia e Hidrografia", "Biogeografia e Domínios Morfoclimáticos do Brasil e do Mundo"],
                "2EM": ["Demografia: Dinâmica Populacional, Migrações, Estrutura Etária", "Urbanização: Processos, Problemas Urbanos, Redes Urbanas", "Geografia Agrária: Sistemas Agrícolas, Questão da Terra, Agronegócio", "Fontes de Energia e Indústria", "Geopolítica Mundial: Conflitos, Blocos Econômicos, Globalização"],
                "3EM": ["Geografia do Brasil: Aspectos Físicos, Humanos e Econômicos (revisão e aprofundamento)", "Regionalização do Espaço Mundial: Países Desenvolvidos e Subdesenvolvidos", "Questões Ambientais Contemporâneas: Aquecimento Global, Desmatamento, Poluição", "Geografia Política e Econômica da América Latina, África e Ásia", "Brasil na Nova Ordem Mundial"]
            },
            "Inglês": {
                "6": ["Greetings and Farewells", "Alphabet and Numbers (1-20)", "Colors", "Classroom Objects", "Family Members (basic)", "Verb 'to be' (am, is, are - affirmative, negative, interrogative)", "Simple Commands", "Animals (common pets and farm animals)"],
                "7": ["Present Simple (daily routines, habits)", "Question Words (What, Who, Where, When, Why, How)", "Prepositions of Place (in, on, under, next to, between)", "Describing People (simple adjectives: tall, short, happy)", "Can/Can't (ability)", "Food and Drinks (common items)", "Telling Time (o'clock, half past)", "Days of the Week, Months of the Year"],
                "8": ["Present Continuous (actions happening now)", "Past Simple (verb 'to be' - was, were)", "Past Simple (regular verbs - affirmative)", "Comparatives and Superlatives (simple adjectives)", "Object Pronouns (me, you, him, her, it, us, them)", "Likes and Dislikes (I like, I don't like + verb-ing)", "Sports and Hobbies"],
                "9": ["Past Simple (irregular verbs - common ones)", "Future with 'will' and 'going to'", "Modal Verbs (should, must, may - basic usage)", "Adverbs of Frequency (always, sometimes, never)", "Countable and Uncountable Nouns (some, any)", "Making Suggestions (Let's..., How about...?)", "Travel and Transportation"],
                "1EM": ["Review of Verb Tenses (Present, Past, Future Simple/Continuous)", "Present Perfect Simple", "Modal Verbs (can, could, may, might, must, should, would)", "Reported Speech (Statements and Questions - basic)", "Passive Voice (Present and Past Simple)", "Reading Comprehension (short articles, stories)"],
                "2EM": ["Past Perfect Simple", "Future Continuous and Future Perfect", "Conditional Sentences (Types 0, 1, 2)", "Relative Clauses (who, which, that, whose, where, when)", "Phrasal Verbs (common ones)", "Reading Comprehension (news articles, opinion pieces)"],
                "3EM": ["Review of all Verb Tenses and Structures", "Conditional Sentences (Type 3 and Mixed)", "Advanced Passive Voice", "Reported Speech (Commands, Requests, Suggestions)", "Connectors and Discourse Markers", "Reading Comprehension (academic texts, literary excerpts, preparation for exams like ENEM/Vestibulares)"]
            },
            "Espanhol": {
                "6": ["Saludos y Despedidas", "Alfabeto y Números (1-20)", "Colores", "Objetos de la Clase", "Mi Familia (básico)", "Verbo 'ser' y 'estar' (presente - formas básicas)", "Mandatos Simples", "Animales (comunes)"],
                "7": ["Presente de Indicativo (rutinas diarias)", "Interrogativos (Qué, Quién, Dónde, Cuándo, Por qué, Cómo)", "Preposiciones de Lugar", "Describir Personas (adjetivos simples)", "Poder (puedo, puedes)", "Comida y Bebida", "Decir la Hora", "Días de la Semana, Meses"],
                "8": ["Presente Continuo (estar + gerundio)", "Pretérito Imperfecto (verbos ser, estar, ir)", "Pretérito Perfecto Simple (verbos regulares)", "Comparativos y Superlativos", "Pronombres de Objeto Directo", "Gustar y Encantar", "Deportes y Aficiones"],
                "9": ["Pretérito Perfecto Simple (verbos irregulares comunes)", "Futuro Simple", "Verbos Modales (deber, tener que, poder - básico)", "Adverbios de Frecuencia", "Sustantivos Contables e Incontables (algunos, ningunos)", "Hacer Sugerencias", "Viajes y Transporte"],
                "1EM": ["Repaso de Tiempos Verbales (Presente, Pretéritos, Futuro Simple)", "Pretérito Perfecto Compuesto", "Verbos Modales (poder, deber, querer, soler)", "Estilo Indirecto (declaraciones y preguntas - básico)", "Voz Pasiva (Presente y Pretérito Indefinido)", "Comprensión Lectora (artículos cortos, cuentos)"],
                "2EM": ["Pretérito Pluscuamperfecto", "Futuro Compuesto y Condicional Simple/Compuesto", "Oraciones Condicionales (Tipos I, II)", "Oraciones de Relativo (que, quien, cual, cuyo, donde, cuando)", "Perífrasis Verbales (comunes)", "Comprensión Lectora (noticias, artículos de opinión)"],
                "3EM": ["Repaso de todos los Tiempos y Estructuras Verbales", "Oraciones Condicionales (Tipo III y Mixtas)", "Voz Pasiva Avanzada", "Estilo Indirecto (órdenes, peticiones, sugerencias)", "Conectores Discursivos", "Comprensión Lectora (textos académicos, literarios, preparación para exámenes)"]
            },
            "Filosofia": {
                "6": ["O que é perguntar? A curiosidade", "O que eu vejo? Percepção e realidade (sentidos)", "Quem sou eu? Identidade e diferenças", "O que é ser amigo? Amizade e convivência", "Certo e Errado: noções iniciais de ética"],
                "7": ["Mitos e suas explicações do mundo", "O que é pensar? Introdução à lógica e ao raciocínio", "O que é a beleza? Noções de estética", "O que é a felicidade? Diferentes visões", "Liberdade e Escolha"],
                "8": ["O que é Filosofia? Origens na Grécia Antiga", "Sócrates: Conhece-te a ti mesmo e o método socrático", "Platão: O mundo das ideias e a Alegoria da Caverna", "Aristóteles: A busca pelo conhecimento e a ética", "O que é o conhecimento? Diferentes formas de saber"],
                "9": ["Filosofia Política: O que é justiça? O que é o Estado?", "Ética e Moral: Dilemas morais contemporâneos", "Existencialismo (introdução): Liberdade e responsabilidade", "Filosofia da Ciência: O que é ciência? Método científico", "Grandes Pensadores e suas contribuições (breve panorama)"],
                "1EM": ["Introdução à Filosofia: O que é? Para que serve?", "Mito e Filosofia (Logos vs. Mythos)", "Filósofos Pré-Socráticos (Tales, Anaximandro, Heráclito, Parmênides)", "Sócrates, Platão e Aristóteles (revisão e aprofundamento)", "Teoria do Conhecimento (Epistemologia): Racionalismo, Empirismo"],
                "2EM": ["Filosofia Medieval (Agostinho, Tomás de Aquino)", "Filosofia Moderna: Descartes, Locke, Hume, Kant", "Filosofia Política: Contratualistas (Hobbes, Locke, Rousseau), Maquiavel", "Ética e Moral (deontologia, utilitarismo, ética das virtudes)"],
                "3EM": ["Filosofia Contemporânea: Hegel, Marx, Nietzsche, Existencialismo (Sartre, Camus, Simone de Beauvoir)", "Escola de Frankfurt, Pós-Modernismo", "Filosofia da Ciência (Popper, Kuhn)", "Questões Filosóficas Atuais (bioética, tecnologia, meio ambiente, identidade)"]
            },
            "Educação Física": {
                 "6": ["Jogos Cooperativos e Competitivos", "Brincadeiras de Roda e Cantigas", "Fundamentos de Esportes de Invasão (futsal, handebol - passe, drible, chute/arremesso)", "Ginástica Rítmica e Artística (elementos básicos)", "Atividades Rítmicas e Expressivas (danças simples)"],
                 "7": ["Esportes de Rede/Parede (vôlei, badminton - fundamentos)", "Esportes de Marca (atletismo - corrida, saltos, arremessos básicos)", "Lutas (judô, capoeira - introdução, movimentos básicos e respeito)", "Primeiros Socorros (noções básicas em caso de acidentes na prática esportiva)", "Saúde e Qualidade de Vida: Alimentação e Atividade Física"],
                 "8": ["Esportes Técnico-Combinatórios (ginástica, nado sincronizado - apreciação e prática de elementos)", "Esportes de Campo e Taco (beisebol/softbol adaptado, críquete adaptado - introdução)", "Dança (ritmos brasileiros e internacionais - criação e apreciação)", "Práticas Corporais de Aventura na Natureza (conceitos, segurança - ex: trilha, slackline adaptado)", "Doping e Fair Play no Esporte"],
                 "9": ["Organização de Eventos Esportivos e Recreativos na Escola", "Análise Crítica da Mídia Esportiva", "Esportes Adaptados e Inclusão", "Planejamento de Treino Físico (noções de carga, intensidade, volume)", "História dos Jogos Olímpicos e Paralímpicos"],
                 "1EM": ["Cultura Corporal do Movimento", "Esportes Coletivos (tática e técnica avançada: Voleibol, Basquetebol, Handebol, Futsal)", "Ginástica Geral e de Condicionamento Físico", "Lutas (aspectos culturais e prática de modalidades diversas)", "Saúde, Qualidade de Vida e Exercício Físico"],
                 "2EM": ["Esportes Individuais (Atletismo, Natação - técnicas e treinamento)", "Dança (história, estilos, criação coreográfica)", "Práticas Corporais Alternativas (Yoga, Pilates, Tai Chi Chuan - introdução)", "Primeiros Socorros (aprofundamento)", "Nutrição Esportiva (noções básicas)"],
                 "3EM": ["Gestão e Organização de Eventos Esportivos", "Mídia e Esporte (análise crítica)", "Políticas Públicas de Esporte e Lazer", "Adaptação de Atividades Físicas para Diferentes Populações", "Planejamento e Prescrição de Treinamento Físico (individualizado)"]
            },
            "Arte": {
                 "6": ["Elementos da Linguagem Visual (ponto, linha, forma, cor, textura, volume)", "Cores Primárias, Secundárias e Terciárias", "Técnicas de Desenho (luz e sombra, perspectiva básica)", "Modelagem (argila, massa de modelar)", "Arte Rupestre e Arte Indígena Brasileira"],
                 "7": ["Arte Egípcia e Grega (arquitetura, escultura, pintura)", "Arte Romana (mosaicos, retratos)", "Arte Medieval (vitrais, iluminuras, arquitetura gótica e românica)", "Gravura (isogravura, xilogravura básica)", "Teatro de Sombras e Marionetes"],
                 "8": ["Renascimento Cultural (principais artistas e características)", "Barroco (Europa e Brasil)", "Fotografia (história e técnicas básicas de composição)", "Arte Abstrata e Figurativa", "Instalações Artísticas e Intervenções Urbanas (conceito)"],
                 "9": ["Movimentos Artísticos do Século XIX (Impressionismo, Pós-Impressionismo)", "Vanguardas Europeias do Século XX (Cubismo, Surrealismo, Expressionismo)", "Arte Moderna e Contemporânea no Brasil (Semana de 22, artistas relevantes)", "Design Gráfico (cartazes, logotipos)", "Arte Digital e Novas Mídias"],
                 "1EM": ["História da Arte: Da Pré-História à Idade Média (revisão e aprofundamento)", "Arte Brasileira: Período Colonial e Academismo", "Elementos da Linguagem Visual e Composição (aprofundamento)", "Técnicas de Pintura e Desenho (experimentação)", "Introdução à Música (elementos, história básica)"],
                 "2EM": ["História da Arte: Renascimento ao Neoclassicismo", "Arte Brasileira: Modernismo (Semana de 22, principais artistas e movimentos)", "Fotografia e Cinema como Expressão Artística", "Teatro: História e Elementos da Encenação", "Arte Contemporânea (conceitos iniciais)"],
                 "3EM": ["História da Arte: Século XIX (Romantismo, Realismo, Impressionismo, Pós-Impressionismo)", "Vanguardas Artísticas Europeias do Século XX", "Arte Contemporânea Brasileira e Internacional (tendências, instalações, performances)", "Arte Digital e Novas Tecnologias na Arte", "Patrimônio Cultural Material e Imaterial"]
            }
        };


        window.onload = function() {
            errorMessageElement = document.getElementById('errorMessage');
            loadingIndicator = document.getElementById('loadingIndicator');
            authSection = document.getElementById('authSection');
            loginForm = document.getElementById('loginForm');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginButton = document.getElementById('loginButton');
            loginErrorMessageElement = document.getElementById('loginErrorMessage');
            signUpForm = document.getElementById('signUpForm');
            signUpUsernameInput = document.getElementById('signUpUsername');
            signUpEmailInput = document.getElementById('signUpEmail');
            signUpPasswordInput = document.getElementById('signUpPassword');
            signUpConfirmPasswordInput = document.getElementById('signUpConfirmPassword');
            signUpButton = document.getElementById('signUpButton');
            signUpErrorMessageElement = document.getElementById('signUpErrorMessage');
            forgotPasswordForm = document.getElementById('forgotPasswordForm');
            forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
            forgotPasswordButton = document.getElementById('forgotPasswordButton');
            forgotPasswordMessageElement = document.getElementById('forgotPasswordMessage');
            showSignUpLink = document.getElementById('showSignUpLink');
            showLoginLinkFromSignUp = document.getElementById('showLoginLinkFromSignUp');
            showForgotPasswordLink = document.getElementById('showForgotPasswordLink');
            showLoginLinkFromForgotPassword = document.getElementById('showLoginLinkFromForgotPassword');
            mainMenuButton = document.getElementById('mainMenuButton');
            mainContentArea = document.getElementById('mainContentArea');
            btnLogout = document.getElementById('btnLogout');
            userInfoDisplay = document.getElementById('userInfo');
            whatsappSupportLink = document.getElementById('whatsappSupportLink');
            profileSection = document.getElementById('profileSection');
            profileEmailDisplay = document.getElementById('profileEmail');
            profileUsernameInput = document.getElementById('profileUsername');
            btnUpdateUsername = document.getElementById('btnUpdateUsername');
            profileUpdateMessage = document.getElementById('profileUpdateMessage');

            fileInput = document.getElementById('fileInput');
            btnProcessFileToSpeech = document.getElementById('btnProcessFileToSpeech');
            btnExportPodcastScriptPdf = document.getElementById('btnExportPodcastScriptPdf');
            podcastScriptDisplayContainer = document.getElementById('podcastScriptDisplayContainer');
            generatedPodcastScriptText = document.getElementById('generatedPodcastScriptText');
            ttsInputText = document.getElementById('ttsInputText');
            btnGenerateSpeechFromText = document.getElementById('btnGenerateSpeechFromText');
            audioPlayer = document.getElementById('audioPlayer');
            audioPlayerContainer = document.getElementById('audioPlayerContainer');
            imagePromptTextarea = document.getElementById('imagePrompt');
            btnGenerateImageFromText = document.getElementById('btnGenerateImageFromText');
            aiGeneratedImageElement = document.getElementById('aiGeneratedImage');
            aiImagePlaceholder = document.getElementById('aiImagePlaceholder');
            aiGeneratedImageContainer = document.getElementById('aiGeneratedImageContainer');
            btnDownloadAiImage = document.getElementById('btnDownloadAiImage');
            btnDeleteAiImage = document.getElementById('btnDeleteAiImage');
            scriptPromptTextarea = document.getElementById('scriptPrompt');
            btnGenerateScript = document.getElementById('btnGenerateScript');
            scriptDisplayContainer = document.getElementById('scriptDisplayContainer');
            generatedScriptText = document.getElementById('generatedScriptText');
            btnPlayScript = document.getElementById('btnPlayScript');
            scriptVoiceSelect = document.getElementById('scriptVoiceSelect');
            scriptTextSizeSelect = document.getElementById('scriptTextSize');
            scriptTextToneSelect = document.getElementById('scriptTextTone');
            activityYearSelect = document.getElementById('activityYearSelect');
            activitySubjectSelect = document.getElementById('activitySubjectSelect');
            activitySpecificContentSelect = document.getElementById('activitySpecificContentSelect');
            activityNumQuestionsSelect = document.getElementById('activityNumQuestionsSelect');
            btnGenerateActivity = document.getElementById('btnGenerateActivity');
            activityDisplayContainer = document.getElementById('activityDisplayContainer');
            generatedActivityText = document.getElementById('generatedActivityText');
            btnExportActivityPdf = document.getElementById('btnExportActivityPdf');
            activityTextSizeSelect = document.getElementById('activityTextSize');
            activityTextToneSelect = document.getElementById('activityTextTone');
            sourceTextToTranslate = document.getElementById('sourceTextToTranslate');
            sourceLanguageSelect = document.getElementById('sourceLanguageSelect');
            targetLanguageSelect = document.getElementById('targetLanguageSelect');
            btnTranslateText = document.getElementById('btnTranslateText');
            translatedTextContainer = document.getElementById('translatedTextContainer');
            translatedTextOutput = document.getElementById('translatedTextOutput');
            btnPlayTranslatedText = document.getElementById('btnPlayTranslatedText');
            translatorVoiceSelect = document.getElementById('translatorVoiceSelect');
            slideTopicInput = document.getElementById('slideTopicInput');
            slideNumSlidesInput = document.getElementById('slideNumSlidesInput');
            slideIncludeImagesCheckbox = document.getElementById('slideIncludeImagesCheckbox');
            btnGenerateSlide = document.getElementById('btnGenerateSlide');
            slideContentContainer = document.getElementById('slideContentContainer');
            generatedSlideContent = document.getElementById('generatedSlideContent');
            btnExportSlidePdf = document.getElementById('btnExportSlidePdf');
            btnExportSlidePptx = document.getElementById('btnExportSlidePptx');
            slideTextSizeSelect = document.getElementById('slideTextSize');
            slideTextToneSelect = document.getElementById('slideTextTone');
            reportTopicInput = document.getElementById('reportTopicInput');
            reportAuthorInput = document.getElementById('reportAuthorInput');
            btnGenerateReport = document.getElementById('btnGenerateReport');
            reportContentContainer = document.getElementById('reportContentContainer');
            generatedReportContent = document.getElementById('generatedReportContent');
            btnExportReportPdf = document.getElementById('btnExportReportPdf');
            reportTextSizeSelect = document.getElementById('reportTextSize');
            reportTextToneSelect = document.getElementById('reportTextTone');
            chatInput = document.getElementById('chatInput');
            btnSendChatMessage = document.getElementById('btnSendChatMessage');
            chatMessagesContainer = document.getElementById('chatMessagesContainer');

            // Novas Funcionalidades
            lessonPlanGeneratorSection = document.getElementById('lessonPlanGeneratorSection');
            lessonPlanYearSelect = document.getElementById('lessonPlanYear');
            lessonPlanSubjectSelect = document.getElementById('lessonPlanSubject');
            lessonPlanContentInput = document.getElementById('lessonPlanContent');
            lessonPlanObjectivesInput = document.getElementById('lessonPlanObjectives');
            lessonPlanDurationInput = document.getElementById('lessonPlanDuration');
            lessonPlanStyleSelect = document.getElementById('lessonPlanStyle');
            lessonPlanSizeSelect = document.getElementById('lessonPlanSize');
            btnGenerateLessonPlan = document.getElementById('btnGenerateLessonPlan');
            lessonPlanDisplayContainer = document.getElementById('lessonPlanDisplayContainer');
            generatedLessonPlanText = document.getElementById('generatedLessonPlanText');
            btnExportLessonPlanPdf = document.getElementById('btnExportLessonPlanPdf');

            subjectVerifierSection = document.getElementById('subjectVerifierSection');
            verifySubjectYearSelect = document.getElementById('verifySubjectYear');
            verifySubjectSubjectSelect = document.getElementById('verifySubjectSubject');
            verifySubjectContentSelect = document.getElementById('verifySubjectContent');
            btnVerifySubject = document.getElementById('btnVerifySubject');
            subjectVerificationDisplayContainer = document.getElementById('subjectVerificationDisplayContainer');
            verifiedSubjectText = document.getElementById('verifiedSubjectText');
            btnExportSubjectVerificationPdf = document.getElementById('btnExportSubjectVerificationPdf');

            proofGeneratorSection = document.getElementById('proofGeneratorSection');
            proofInstitutionNameInput = document.getElementById('proofInstitutionName');
            proofTeacherNameInput = document.getElementById('proofTeacherName');
            proofYearSelect = document.getElementById('proofYear');
            proofSubjectSelect = document.getElementById('proofSubject');
            proofContentInput = document.getElementById('proofContent');
            proofNumQuestionsSelect = document.getElementById('proofNumQuestions');
            proofQuestionTypeSelect = document.getElementById('proofQuestionType');
            proofHeaderImageInput = document.getElementById('proofHeaderImage');
            btnGenerateProof = document.getElementById('btnGenerateProof');
            proofDisplayContainer = document.getElementById('proofDisplayContainer');
            generatedProofText = document.getElementById('generatedProofText');
            btnExportProofPdf = document.getElementById('btnExportProofPdf');


            if (window.firebaseServices && window.firebaseServices.auth) {
                setupLoginSystem(window.firebaseServices);
            } else {
                console.error("Firebase Auth não disponível no window.onload. O sistema de login não pode ser inicializado.");
                displayErrorMessage("Erro crítico: Autenticação não disponível.");
                if(authSection) authSection.style.display = 'flex';
                toggleAuthForms('login');
                if(loginErrorMessageElement) {
                    loginErrorMessageElement.textContent = "Serviço de autenticação indisponível.";
                    loginErrorMessageElement.style.display = 'block';
                }
            }

            populateActivityYears();
            populateVoiceSelectors();
            populateActivitySubjects();
            updateSpecificContentOptions();
            setupNavigationAndEventListeners();
        };

        function setupLoginSystem(firebase) {
            if (!firebase || !firebase.auth || !loginForm || !signUpForm || !forgotPasswordForm || !btnLogout || !showSignUpLink || !showLoginLinkFromSignUp || !showForgotPasswordLink || !showLoginLinkFromForgotPassword || !btnUpdateUsername) {
                console.error("Elementos do sistema de autenticação ou perfil não encontrados ou Firebase Auth não inicializado.");
                if(authSection) authSection.style.display = 'flex';
                return;
            }

            loginForm.addEventListener('submit', (e) => handleLoginAttempt(e, firebase));
            signUpForm.addEventListener('submit', (e) => handleSignUpAttempt(e, firebase));
            forgotPasswordForm.addEventListener('submit', (e) => handleForgotPassword(e, firebase));
            btnLogout.addEventListener('click', () => handleLogout(firebase));
            btnUpdateUsername.addEventListener('click', () => handleUpdateUsername(firebase));


            showSignUpLink.addEventListener('click', () => toggleAuthForms('signUp'));
            showLoginLinkFromSignUp.addEventListener('click', () => toggleAuthForms('login'));
            showForgotPasswordLink.addEventListener('click', () => toggleAuthForms('forgotPassword'));
            showLoginLinkFromForgotPassword.addEventListener('click', () => toggleAuthForms('login'));

            firebase.onAuthStateChanged(firebase.auth, user => {
                if (user) {
                    console.log("Usuário está logado:", user.email, "Nome de Exibição:", user.displayName);
                    updateUIAfterLogin(user);
                } else {
                    console.log("Nenhum usuário logado.");
                    updateUIAfterLogout();
                }
                hideLoading();
            });
        }

        function toggleAuthForms(formToShow) {
            clearAuthErrors();
            if(loginForm) loginForm.style.display = (formToShow === 'login') ? 'block' : 'none';
            if(signUpForm) signUpForm.style.display = (formToShow === 'signUp') ? 'block' : 'none';
            if(forgotPasswordForm) forgotPasswordForm.style.display = (formToShow === 'forgotPassword') ? 'block' : 'none';
        }

        async function handleLoginAttempt(event, firebase) {
            event.preventDefault();
            if (!loginEmailInput || !loginPasswordInput || !firebase || !firebase.auth) return;
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            clearAuthErrors();
            showLoading("A tentar login...");
            try {
                await firebase.signInWithEmailAndPassword(firebase.auth, email, password);
            } catch (error) {
                console.error("Erro no login:", error);
                displayLoginError(mapFirebaseAuthError(error.code));
                hideLoading();
            }
        }

        async function handleSignUpAttempt(event, firebase) {
            event.preventDefault();
            if (!signUpUsernameInput || !signUpEmailInput || !signUpPasswordInput || !signUpConfirmPasswordInput || !firebase || !firebase.auth) return;
            const username = signUpUsernameInput.value.trim();
            const email = signUpEmailInput.value;
            const password = signUpPasswordInput.value;
            const confirmPassword = signUpConfirmPasswordInput.value;
            clearAuthErrors();

            if (!username) {
                displaySignUpError("Por favor, insira um nome de usuário.");
                return;
            }
            if (password.length < 6) {
                displaySignUpError("A senha deve ter pelo menos 6 caracteres.");
                return;
            }
            if (password !== confirmPassword) {
                displaySignUpError("As senhas não coincidem.");
                return;
            }
            showLoading("A criar conta...");
            try {
                const userCredential = await firebase.createUserWithEmailAndPassword(firebase.auth, email, password);
                await firebase.updateProfile(userCredential.user, { displayName: username });
                console.log("Conta criada e perfil atualizado para:", userCredential.user.email, "Nome:", username);
            } catch (error) {
                console.error("Erro ao criar conta:", error);
                displaySignUpError(mapFirebaseAuthError(error.code));
                hideLoading();
            }
        }

        async function handleForgotPassword(event, firebase) {
            event.preventDefault();
            if (!forgotPasswordEmailInput || !firebase || !firebase.auth) return;
            const email = forgotPasswordEmailInput.value;
            clearAuthErrors();
            showLoading("A enviar link de redefinição...");
            try {
                await firebase.sendPasswordResetEmail(firebase.auth, email);
                if(forgotPasswordMessageElement) {
                    forgotPasswordMessageElement.textContent = "Link de redefinição de senha enviado para " + email + ". Verifique sua caixa de entrada e spam.";
                    forgotPasswordMessageElement.style.backgroundColor = "var(--btn-green)";
                    forgotPasswordMessageElement.style.color = "white";
                    forgotPasswordMessageElement.style.display = 'block';
                }
                forgotPasswordEmailInput.value = '';
            } catch (error) {
                console.error("Erro ao enviar e-mail de redefinição:", error);
                if(forgotPasswordMessageElement) {
                    forgotPasswordMessageElement.textContent = mapFirebaseAuthError(error.code);
                    forgotPasswordMessageElement.style.backgroundColor = "#721c24";
                    forgotPasswordMessageElement.style.color = "#f8d7da";
                    forgotPasswordMessageElement.style.display = 'block';
                }
            } finally {
                hideLoading();
            }
        }

        async function handleLogout(firebase) {
            if (!firebase || !firebase.auth) return;
            showLoading("A sair...");
            try {
                await firebase.signOut(firebase.auth);
            } catch (error) {
                console.error("Erro ao deslogar:", error);
                displayErrorMessage("Erro ao tentar sair.");
                hideLoading();
            }
        }

        async function handleUpdateUsername(firebase) {
            if (!profileUsernameInput || !firebase || !firebase.auth || !firebase.auth.currentUser) {
                displayProfileUpdateMessage("Erro: Usuário não logado ou campo de nome não encontrado.", true);
                return;
            }
            const newUsername = profileUsernameInput.value.trim();
            if (!newUsername) {
                displayProfileUpdateMessage("O nome de usuário não pode estar vazio.", true);
                return;
            }
            showLoading("A atualizar nome...");
            try {
                await firebase.updateProfile(firebase.auth.currentUser, { displayName: newUsername });
                displayProfileUpdateMessage("Nome de usuário atualizado com sucesso!", false);
                if (userInfoDisplay) userInfoDisplay.textContent = `Olá, ${newUsername}!`;
            } catch (error) {
                console.error("Erro ao atualizar nome de usuário:", error);
                displayProfileUpdateMessage(`Erro ao atualizar: ${mapFirebaseAuthError(error.code)}`, true);
            } finally {
                hideLoading();
            }
        }


        function updateUIAfterLogin(user) {
            if(authSection) authSection.style.display = 'none';
            if(mainContentArea) {
                mainContentArea.style.display = 'block';
                setTimeout(() => mainContentArea.classList.add('visible'), 10);
            }
            if(mainMenuButton) mainMenuButton.style.display = 'inline-flex';
            if(btnLogout) btnLogout.style.display = 'inline-flex';
            if(whatsappSupportLink) whatsappSupportLink.style.display = 'flex';

            if(userInfoDisplay && user) {
                userInfoDisplay.textContent = `Olá, ${user.displayName || user.email}!`;
                userInfoDisplay.style.display = 'block';
            }
            if(profileEmailDisplay && user) profileEmailDisplay.value = user.email;
            if(profileUsernameInput && user) profileUsernameInput.value = user.displayName || '';


            const firstValidSectionLink = document.querySelector('.side-menu .tool-link[data-target="fileToPodcastSection"]');
            if (firstValidSectionLink) {
                firstValidSectionLink.click();
            }
        }

        function updateUIAfterLogout() {
            if(authSection) authSection.style.display = 'flex';
            toggleAuthForms('login');
            if(mainContentArea) {
                mainContentArea.classList.remove('visible');
                setTimeout(() => { if(mainContentArea) mainContentArea.style.display = 'none'; }, 300);
            }
            if(mainMenuButton) mainMenuButton.style.display = 'none';
            if(btnLogout) btnLogout.style.display = 'none';
            if(userInfoDisplay) userInfoDisplay.style.display = 'none';
            if(whatsappSupportLink) whatsappSupportLink.style.display = 'none';

            const sideMenu = document.getElementById('sideMenu');
            if(sideMenu) sideMenu.style.width = '0';
            clearAllOutputsAndInputs();
        }

        function displayLoginError(message) {
            if (!loginErrorMessageElement) return;
            loginErrorMessageElement.textContent = message;
            loginErrorMessageElement.style.display = 'block';
        }
        function displaySignUpError(message) {
            if (!signUpErrorMessageElement) return;
            signUpErrorMessageElement.textContent = message;
            signUpErrorMessageElement.style.display = 'block';
        }
        function displayProfileUpdateMessage(message, isError) {
            if (!profileUpdateMessage) return;
            profileUpdateMessage.textContent = message;
            profileUpdateMessage.style.backgroundColor = isError ? "#721c24" : "var(--btn-green)";
            profileUpdateMessage.style.color = isError ? "#f8d7da" : "white";
            profileUpdateMessage.style.display = 'block';
            setTimeout(() => {
                if (profileUpdateMessage) profileUpdateMessage.style.display = 'none';
            }, 3000);
        }


        function clearAuthErrors() {
            if (loginErrorMessageElement) {
                loginErrorMessageElement.textContent = '';
                loginErrorMessageElement.style.display = 'none';
            }
            if (signUpErrorMessageElement) {
                signUpErrorMessageElement.textContent = '';
                signUpErrorMessageElement.style.display = 'none';
            }
            if (forgotPasswordMessageElement) {
                forgotPasswordMessageElement.textContent = '';
                forgotPasswordMessageElement.style.display = 'none';
            }
            if (profileUpdateMessage) {
                profileUpdateMessage.textContent = '';
                profileUpdateMessage.style.display = 'none';
            }
        }

        function showLoading(message = "Aguarde...") {
            if(loadingIndicator) {
                const textElement = loadingIndicator.querySelector('p') || loadingIndicator;
                if (textElement === loadingIndicator && !loadingIndicator.querySelector('p')) {
                    const p = document.createElement('p');
                    loadingIndicator.appendChild(p);
                    textElement = p;
                }
                if(textElement) textElement.textContent = message;

                let spinner = loadingIndicator.querySelector('i.fa-spinner');
                if (!spinner) {
                    spinner = document.createElement('i');
                    spinner.className = 'fas fa-spinner';
                    loadingIndicator.prepend(spinner);
                }
                loadingIndicator.style.display = 'flex';
            }
        }
        function hideLoading() {
            if(loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }

         function clearAllOutputsAndInputs() {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(ta => ta.value = '');
            const inputs = document.querySelectorAll('input[type="text"], input[type="file"], input[type="email"], input[type="password"]');
            inputs.forEach(input => {
                if(input.closest('#authSection') || input.closest('#profileSection')) return;
                input.value = '';
            });

            if(typeof apagarImagemGeradaIA === "function") apagarImagemGeradaIA();
            if(audioPlayerContainer) audioPlayerContainer.style.display = 'none';
            if(audioPlayer && audioPlayer.src) audioPlayer.src = '';

            const resultContainers = [
                podcastScriptDisplayContainer, scriptDisplayContainer,
                activityDisplayContainer, translatedTextContainer, slideContentContainer, reportContentContainer,
                lessonPlanDisplayContainer, subjectVerificationDisplayContainer, proofDisplayContainer
            ];
            resultContainers.forEach(container => {
                if (container) container.style.display = 'none';
            });

            const resultTexts = [
                generatedPodcastScriptText, generatedScriptText,
                generatedActivityText, translatedTextOutput, generatedSlideContent,
                generatedReportContent, generatedLessonPlanText, verifiedSubjectText, generatedProofText
            ];
            resultTexts.forEach(textElement => {
                if (textElement) textElement.textContent = '';
            });

            if(chatMessagesContainer) chatMessagesContainer.innerHTML = '';
            radimakChatHistory = [];

            const dynamicButtons = [
                btnExportPodcastScriptPdf, btnPlayScript, btnExportActivityPdf,
                btnPlayTranslatedText, btnExportSlidePdf, btnExportSlidePptx,
                btnExportReportPdf, btnExportLessonPlanPdf, btnExportSubjectVerificationPdf, btnExportProofPdf
            ];
            dynamicButtons.forEach(button => {
                if (button) button.style.display = 'none';
            });
            clearErrorMessage();
        }


        function mapFirebaseAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Formato de e-mail inválido.';
                case 'auth/user-disabled':
                    return 'Este usuário foi desabilitado.';
                case 'auth/user-not-found':
                case 'auth/invalid-credential':
                    return 'E-mail ou senha inválidos.';
                case 'auth/wrong-password':
                    return 'Senha incorreta.';
                case 'auth/email-already-in-use':
                    return 'Este e-mail já está em uso por outra conta.';
                case 'auth/weak-password':
                    return 'A senha é muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/missing-password':
                    return 'Por favor, insira a senha.';
                default:
                    console.error("Firebase Auth Error Code:", errorCode);
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }

        function populateActivityYears() {
            const yearSelectors = [activityYearSelect, lessonPlanYearSelect, verifySubjectYearSelect, proofYearSelect];
            const anos = [
                { value: "6", text: "6º Ano - Ensino Fundamental" },
                { value: "7", text: "7º Ano - Ensino Fundamental" },
                { value: "8", text: "8º Ano - Ensino Fundamental" },
                { value: "9", text: "9º Ano - Ensino Fundamental" },
                { value: "1EM", text: "1º Ano - Ensino Médio" },
                { value: "2EM", text: "2º Ano - Ensino Médio" },
                { value: "3EM", text: "3º Ano - Ensino Médio" }
            ];
            yearSelectors.forEach(selector => {
                if (selector) {
                    selector.innerHTML = '';
                    anos.forEach(ano => {
                        const option = document.createElement('option');
                        option.value = ano.value;
                        option.textContent = ano.text;
                        selector.appendChild(option);
                    });
                }
            });
        }


        function setupNavigationAndEventListeners() {
            const navLinks = document.querySelectorAll('.side-menu .tool-link');
            const generatorSections = document.querySelectorAll('.generator-section');
            const pageMainMenuButton = document.getElementById('mainMenuButton');
            const closeMenuButton = document.getElementById('closeMenuButton');
            const sideMenu = document.getElementById('sideMenu');

            if (pageMainMenuButton) {
                pageMainMenuButton.addEventListener('click', () => {
                    if (sideMenu) sideMenu.style.width = '280px';
                });
            }

            if (closeMenuButton) {
                closeMenuButton.addEventListener('click', () => {
                    if (sideMenu) sideMenu.style.width = '0';
                });
            }

            navLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const targetId = this.getAttribute('data-target');

                    navLinks.forEach(navLink => navLink.classList.remove('active'));
                    this.classList.add('active');

                    generatorSections.forEach(section => {
                        if (section) {
                            if (section.id === targetId) {
                                section.style.display = 'block';
                                setTimeout(() => { section.classList.add('active'); }, 10);
                            } else {
                                section.classList.remove('active');
                                // A transição de opacidade é feita pelo CSS quando 'active' é removido.
                                // O display:none é aplicado após a transição para não cortar abruptamente.
                                setTimeout(() => {
                                    if (!section.classList.contains('active')) { // Checa novamente para evitar esconder a seção que acabou de ser ativada
                                        section.style.display = 'none';
                                    }
                                }, 300); // Duração da transição de opacidade
                            }
                        }
                    });
                    clearErrorMessage();
                    if (audioPlayerContainer) audioPlayerContainer.style.display = 'none';
                    if (sideMenu) sideMenu.style.width = '0';
                });
            });


            // Event listeners for app functionalities
            if (btnGenerateImageFromText) btnGenerateImageFromText.addEventListener('click', gerarImagemComIA);
            if (btnDownloadAiImage) btnDownloadAiImage.addEventListener('click', baixarImagemGeradaIA);
            if (btnDeleteAiImage) btnDeleteAiImage.addEventListener('click', apagarImagemGeradaIA);
            if (btnGenerateSpeechFromText) btnGenerateSpeechFromText.addEventListener('click', () => {
                const textToSpeak = ttsInputText.value.trim();
                const selectedVoice = document.getElementById('ttsVoiceSelect').value;
                if (textToSpeak) {
                    gerarFalaComIA(textToSpeak, "Texto Introduzido", false, selectedVoice);
                } else {
                    displayErrorMessage("Por favor, introduza o texto que deseja converter em fala.");
                }
            });
            if (btnProcessFileToSpeech) btnProcessFileToSpeech.addEventListener('click', processFileToSpeech);
            if (btnGenerateScript) btnGenerateScript.addEventListener('click', gerarGuiaoHistoria);
            if (btnPlayScript) btnPlayScript.addEventListener('click', () => {
                const scriptContent = generatedScriptText.textContent;
                const selectedVoice = scriptVoiceSelect.value;
                if (scriptContent) {
                    gerarFalaComIA(scriptContent, "Guião/História Gerada", false, selectedVoice);
                }
            });
            if (btnGenerateActivity) btnGenerateActivity.addEventListener('click', gerarAtividadesComIA);
            if (activityYearSelect) activityYearSelect.addEventListener('change', updateSpecificContentOptions);
            if (activitySubjectSelect) activitySubjectSelect.addEventListener('change', updateSpecificContentOptions);

            if (btnExportPodcastScriptPdf) btnExportPodcastScriptPdf.addEventListener('click', () => exportTextToPdf(generatedPodcastScriptText.textContent, "guiao_podcast.pdf"));
            if (btnExportActivityPdf) btnExportActivityPdf.addEventListener('click', () => exportTextToPdf(generatedActivityText.textContent, "atividades_geradas.pdf"));
            if (btnTranslateText) btnTranslateText.addEventListener('click', translateTextWithAI);
            if (btnPlayTranslatedText) btnPlayTranslatedText.addEventListener('click', () => {
                const translatedContent = translatedTextOutput.textContent;
                const selectedVoice = translatorVoiceSelect.value;
                if (translatedContent) {
                    gerarFalaComIA(translatedContent, "Texto Traduzido", false, selectedVoice);
                }
            });
            if (btnGenerateSlide) btnGenerateSlide.addEventListener('click', gerarSlidesComIA);
            if (btnExportSlidePdf) btnExportSlidePdf.addEventListener('click', () => exportTextToPdf(generatedSlideContent.innerText, "apresentacao_slides.pdf"));
            if (btnExportSlidePptx) btnExportSlidePptx.addEventListener('click', exportSlidesToPptx);
            if (btnExportReportPdf) btnExportReportPdf.addEventListener('click', () => exportTextToPdf(generatedReportContent.innerText, "relatorio_gerado.pdf"));
            if (btnGenerateReport) btnGenerateReport.addEventListener('click', gerarRelatorioComIA);
            if (btnSendChatMessage) btnSendChatMessage.addEventListener('click', enviarMensagemChatRadimak);

            // Listeners para Novas Funcionalidades
            if (btnGenerateLessonPlan) btnGenerateLessonPlan.addEventListener('click', gerarPlanejamentoDeAula);
            if (btnExportLessonPlanPdf) btnExportLessonPlanPdf.addEventListener('click', () => exportTextToPdf(generatedLessonPlanText.textContent, "planejamento_aula.pdf"));
            if (btnVerifySubject) btnVerifySubject.addEventListener('click', verificarAssunto);
            if (btnExportSubjectVerificationPdf) btnExportSubjectVerificationPdf.addEventListener('click', () => exportTextToPdf(verifiedSubjectText.textContent, "verificacao_assunto.pdf"));
            if (btnGenerateProof) btnGenerateProof.addEventListener('click', gerarProva);
            if (btnExportProofPdf) btnExportProofPdf.addEventListener('click', () => exportTextToPdf(generatedProofText.textContent, "prova_gerada.pdf"));

            if (lessonPlanYearSelect) lessonPlanYearSelect.addEventListener('change', () => updateSpecificContentOptionsForForm(lessonPlanYearSelect, lessonPlanSubjectSelect, null));
            if (lessonPlanSubjectSelect) lessonPlanSubjectSelect.addEventListener('change', () => updateSpecificContentOptionsForForm(lessonPlanYearSelect, lessonPlanSubjectSelect, null));
            if (verifySubjectYearSelect) verifySubjectYearSelect.addEventListener('change', () => updateSpecificContentOptionsForForm(verifySubjectYearSelect, verifySubjectSubjectSelect, verifySubjectContentSelect));
            if (verifySubjectSubjectSelect) verifySubjectSubjectSelect.addEventListener('change', () => updateSpecificContentOptionsForForm(verifySubjectYearSelect, verifySubjectSubjectSelect, verifySubjectContentSelect));
            if (proofYearSelect) proofYearSelect.addEventListener('change', () => updateSpecificContentOptionsForForm(proofYearSelect, proofSubjectSelect, null));
            if (proofSubjectSelect) proofSubjectSelect.addEventListener('change', () => updateSpecificContentOptionsForForm(proofYearSelect, proofSubjectSelect, null));


            if (audioPlayer) audioPlayer.onerror = function(e) {
                console.error("Erro no elemento de áudio:", e);
                let specificError = "Erro desconhecido ao carregar o áudio.";
                if (audioPlayer.error) {
                    switch (audioPlayer.error.code) {
                        case MediaError.MEDIA_ERR_ABORTED: specificError = "A reprodução do áudio foi abortada."; break;
                        case MediaError.MEDIA_ERR_NETWORK: specificError = "Ocorreu um erro de rede ao carregar o áudio."; break;
                        case MediaError.MEDIA_ERR_DECODE: specificError = "Ocorreu um erro ao descodificar o áudio. O formato pode ser inválido ou não suportado."; break;
                        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: specificError = "O formato do áudio não é suportado ou a fonte não pôde ser encontrada."; break;
                        default: specificError = `Ocorreu um erro ao carregar o áudio (código: ${audioPlayer.error.code}).`;
                    }
                }
                displayErrorMessage(specificError + ` (Tipo MIME tentado: ${lastAttemptedMimeType})`);
                if (audioPlayerContainer) audioPlayerContainer.style.display = 'none';
            };
        }

        function populateVoiceSelectors() {
            const selectors = [
                { id: 'podcastSpeaker1Voice', default: 'Charon' },
                { id: 'podcastSpeaker2Voice', default: 'Kore' },
                { id: 'ttsVoiceSelect', default: 'Zephyr' },
                { id: 'scriptVoiceSelect', default: 'Zephyr' },
                { id: 'translatorVoiceSelect', default: 'Zephyr'}
            ];

            selectors.forEach(selInfo => {
                const selectElement = document.getElementById(selInfo.id);
                if (selectElement) {
                    selectElement.innerHTML = '';
                    availableVoices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.value;
                        option.textContent = voice.name;
                        if (voice.value === selInfo.default) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                }
            });
        }

        function populateActivitySubjects() {
            const subjectSelectors = [activitySubjectSelect, lessonPlanSubjectSelect, verifySubjectSubjectSelect, proofSubjectSelect];
            const subjects = Object.keys(conteudosPorMateriaAno);

            subjectSelectors.forEach(selector => {
                if (selector) {
                    selector.innerHTML = '';
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        selector.appendChild(option);
                    });
                }
            });
            updateSpecificContentOptionsForForm(activityYearSelect, activitySubjectSelect, activitySpecificContentSelect);
            updateSpecificContentOptionsForForm(lessonPlanYearSelect, lessonPlanSubjectSelect, null);
            updateSpecificContentOptionsForForm(verifySubjectYearSelect, verifySubjectSubjectSelect, verifySubjectContentSelect);
            updateSpecificContentOptionsForForm(proofYearSelect, proofSubjectSelect, null);
        }


        function updateSpecificContentOptions() {
            updateSpecificContentOptionsForForm(activityYearSelect, activitySubjectSelect, activitySpecificContentSelect);
        }

        function updateSpecificContentOptionsForForm(yearSelect, subjectSelect, contentSelect) {
            if (!yearSelect || !subjectSelect ) return;
            const selectedYear = yearSelect.value;
            const selectedSubject = subjectSelect.value;

            if (contentSelect) {
                contentSelect.innerHTML = '';
                if (conteudosPorMateriaAno[selectedSubject] && conteudosPorMateriaAno[selectedSubject][selectedYear]) {
                    const contents = conteudosPorMateriaAno[selectedSubject][selectedYear];
                    contents.forEach(content => {
                        const option = document.createElement('option');
                        option.value = content;
                        option.textContent = content;
                        contentSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Nenhum conteúdo disponível";
                    option.disabled = true;
                    contentSelect.appendChild(option);
                }
            }
        }


        function displayErrorMessage(message) {
            if (!errorMessageElement) return;
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
            errorMessageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function clearErrorMessage() {
            if (!errorMessageElement) return;
            errorMessageElement.textContent = '';
            errorMessageElement.style.display = 'none';
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(new Error(`Erro ao ler o ficheiro: ${error.message}`));
                reader.readAsDataURL(file);
            });
        }

        function readFileAsText(file) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(new Error(`Erro ao ler o ficheiro de texto: ${error.message}`));
                reader.readAsText(file);
            });
        }


        async function getSummaryForTTS(data, mimeType, fileType) {
            if (!geminiFlashApiKey) throw new Error("API key para Gemini Flash não configurada.");
            let promptText = "";
            let maxTokens = 2000;
            let contentPart;

            if (fileType === "image" || fileType === "pdf") {
                promptText = fileType === "image"
                    ? "Crie um resumo detalhado desta imagem, com informação suficiente para gerar um diálogo de podcast com cerca de 2-3 minutos de duração. Destaque os elementos visuais principais, a atmosfera geral e em quaisquer textos visíveis. Seja descritivo e envolvente. Não use formatação Markdown como asteriscos."
                    : "Crie um resumo detalhado e abrangente deste documento PDF, com informação suficiente para gerar um diálogo de podcast com aproximadamente 7 minutos de duração. Foque-se nas ideias principais, argumentos, exemplos e conclusões, omitindo apenas detalhes menores ou informação redundante. O objetivo é ter material rico para uma discussão entre duas vozes. Não use formatação Markdown como asteriscos.";
                maxTokens = fileType === "image" ? 700 : 3500;
                contentPart = { inlineData: { mimeType: mimeType, data: data } };
            } else if (fileType === "text") {
                 promptText = "Crie um resumo detalhado e abrangente deste texto, com informação suficiente para gerar um diálogo de podcast com aproximadamente 7 minutos de duração. Foque-se nas ideias principais, argumentos, exemplos e conclusões. O objetivo é ter material rico para uma discussão entre duas vozes. Não use formatação Markdown como asteriscos.";
                maxTokens = 3500;
                contentPart = { text: data };
            } else {
                throw new Error("Tipo de ficheiro não suportado para resumo.");
            }

            const payload = {
                contents: [{ role: "user", parts: [{ text: promptText }, contentPart] }],
                generationConfig: { maxOutputTokens: maxTokens, temperature: 0.6 }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
            showLoading(`A gerar resumo de ${fileType}...`);
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erro ao obter resumo de ${fileType} (${response.status}): ${errorData?.error?.message || response.statusText}`);
            }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
            }
            throw new Error(`Não foi possível extrair o resumo de ${fileType} da API.`);
        }

        async function generateDialogueFromSummary(summaryText) {
            if (!geminiFlashApiKey) throw new Error("API key para Gemini Flash (geração de diálogo) não configurada.");
            showLoading("A criar guião de diálogo para o podcast...");

            const prompt = `Com base no seguinte resumo detalhado, crie um guião de diálogo extenso e envolvente (visando aproximadamente 1000-1500 palavras) entre duas pessoas (identificadas como "Speaker 1:" e "Speaker 2:") para um podcast. O diálogo deve explorar os pontos principais do resumo de forma natural, aprofundada e conversacional. Formate o guião claramente com "Speaker 1:" e "Speaker 2:" antes de cada fala. Não adicione nenhuma introdução ou conclusão ao diálogo, apenas as falas dos speakers. Não use formatação Markdown como asteriscos. Resumo:\n\n${summaryText}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { maxOutputTokens: 2500, temperature: 0.75 }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erro ao gerar diálogo (${response.status}): ${errorData?.error?.message || response.statusText}`);
            }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const dialogue = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                if(generatedPodcastScriptText) generatedPodcastScriptText.textContent = dialogue;
                if(podcastScriptDisplayContainer) podcastScriptDisplayContainer.style.display = 'block';
                if(btnExportPodcastScriptPdf) btnExportPodcastScriptPdf.style.display = 'inline-flex';
                return dialogue;
            }
            throw new Error("Não foi possível gerar o guião do diálogo a partir do resumo.");
        }


        async function processFileToSpeech() {
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                displayErrorMessage("Por favor, selecione um ficheiro.");
                return;
            }
            const file = fileInput.files[0];

            clearErrorMessage();
            showLoading("A processar ficheiro...");
            if(audioPlayerContainer) audioPlayerContainer.style.display = 'none';
            if(podcastScriptDisplayContainer) podcastScriptDisplayContainer.style.display = 'none';
            if(btnExportPodcastScriptPdf) btnExportPodcastScriptPdf.style.display = 'none';

            try {
                let summaryText = "";
                let fileDescriptionForTTS = file.name;
                let fileTypeForSummary = "";
                let fileContentForSummary;

                if (file.type.startsWith("image/")) {
                    fileTypeForSummary = "image";
                    fileContentForSummary = await readFileAsBase64(file);
                    summaryText = await getSummaryForTTS(fileContentForSummary, file.type, fileTypeForSummary);
                    fileDescriptionForTTS = `Podcast sobre a imagem ${file.name}`;
                } else if (file.type === "application/pdf") {
                    fileTypeForSummary = "pdf";
                    fileContentForSummary = await readFileAsBase64(file);
                    summaryText = await getSummaryForTTS(fileContentForSummary, "application/pdf", fileTypeForSummary);
                    fileDescriptionForTTS = `Podcast sobre o PDF ${file.name}`;
                } else if (file.type === "text/plain") {
                    fileTypeForSummary = "text";
                    fileContentForSummary = await readFileAsText(file);
                    summaryText = await getSummaryForTTS(fileContentForSummary, "text/plain", fileTypeForSummary);
                    fileDescriptionForTTS = `Podcast sobre o ficheiro ${file.name}`;
                } else {
                    throw new Error(`Tipo de ficheiro não suportado: ${file.type}. Por favor, selecione uma imagem, PDF ou ficheiro .txt.`);
                }

                if (summaryText) {
                    const dialogueScript = await generateDialogueFromSummary(summaryText);
                    if (dialogueScript) {
                        await gerarFalaComIA(dialogueScript, fileDescriptionForTTS, true);
                    } else {
                        throw new Error("Falha ao gerar o guião do diálogo.");
                    }
                } else {
                    throw new Error("Não foi possível extrair ou resumir conteúdo do ficheiro para conversão em fala.");
                }

            } catch (error) {
                console.error("Erro ao processar ficheiro para fala:", error);
                displayErrorMessage(`Erro ao processar ficheiro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function gerarGuiaoHistoria() {
            if (!scriptPromptTextarea || !scriptTextSizeSelect || !scriptTextToneSelect) { displayErrorMessage("Elementos do formulário de guião não encontrados."); return; }
            const promptText = scriptPromptTextarea.value.trim();
            const textSize = scriptTextSizeSelect.value;
            const textTone = scriptTextToneSelect.value;

            if (!promptText) {
                displayErrorMessage("Por favor, forneça um tema ou ideia para o guião/história.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar guião/história...");
            if(scriptDisplayContainer) scriptDisplayContainer.style.display = 'none';
            if(btnPlayScript) btnPlayScript.style.display = 'none';

            const generationPrompt = `Crie um guião ou uma história com base no seguinte: "${promptText}". O texto deve ter um tamanho ${textSize} e um tom ${textTone}. Se for um guião, defina claramente os personagens e as suas falas (ex: PERSONAGEM: Fala.). Se for uma história, escreva uma narrativa envolvente. Não use formatação Markdown como asteriscos.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: generationPrompt }] }],
                    generationConfig: { temperature: 0.8, maxOutputTokens: textSize === 'grande' ? 1200 : (textSize === 'médio' ? 800 : 400) }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao gerar guião (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const script = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(generatedScriptText) generatedScriptText.textContent = script;
                    if(scriptDisplayContainer) scriptDisplayContainer.style.display = 'block';
                    if(btnPlayScript) btnPlayScript.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter o guião/história da resposta da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        async function gerarAtividadesComIA() {
            if (!activityYearSelect || !activitySubjectSelect || !activitySpecificContentSelect || !document.getElementById('activityQuestionTypeSelect') || !activityNumQuestionsSelect || !activityTextSizeSelect || !activityTextToneSelect) {
                displayErrorMessage("Alguns elementos do formulário de atividades não foram encontrados."); return;
            }
            const ano = activityYearSelect.value;
            const materia = activitySubjectSelect.value;
            const conteudo = activitySpecificContentSelect.value;
            const tipoQuestao = document.getElementById('activityQuestionTypeSelect').value;
            const numQuestoes = activityNumQuestionsSelect.value;
            const textSize = activityTextSizeSelect.value;
            const textTone = activityTextToneSelect.value;


            if (!conteudo) {
                displayErrorMessage("Por favor, selecione o conteúdo específico para as atividades.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar atividades...");
            if(activityDisplayContainer) activityDisplayContainer.style.display = 'none';
            if(btnExportActivityPdf) btnExportActivityPdf.style.display = 'none';

            let tipoQuestaoPrompt = "";
            if (tipoQuestao === "Objetivas") {
                tipoQuestaoPrompt = "As questões devem ser primariamente objetivas (ex: múltipla escolha com 4 alternativas, verdadeiro ou falso).";
            } else if (tipoQuestao === "Subjetivas") {
                tipoQuestaoPrompt = "As questões devem ser primariamente subjetivas (ex: dissertativas curtas, resolução de problemas passo a passo, interpretação).";
            } else {
                tipoQuestaoPrompt = "As questões devem ser variadas, incluindo tanto objetivas (ex: múltipla escolha, V/F) quanto subjetivas (ex: dissertativas curtas, problemas).";
            }

            const prompt = `Crie ${numQuestoes} questões de ${materia} para alunos do ${activityYearSelect.options[activityYearSelect.selectedIndex].text}, focadas no seguinte conteúdo: "${conteudo}". ${tipoQuestaoPrompt} As questões devem ser claras e adequadas ao nível de ensino, com um tamanho de texto ${textSize} e um tom ${textTone}. Formate a saída de forma organizada, numerando cada questão. Se incluir questões de múltipla escolha, forneça 4 alternativas (A, B, C, D) e indique a resposta correta no final de cada questão objetiva entre parênteses, por exemplo: (Resposta: C). Não use formatação Markdown como asteriscos. Inclua um cabeçalho simples no início do texto gerado com o nome da Matéria, Ano/Série e Conteúdo.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.6, maxOutputTokens: textSize === 'grande' ? 2500 : (textSize === 'médio' ? 2000 : 1500) }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao gerar atividades (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const activities = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(generatedActivityText) generatedActivityText.textContent = activities;
                    if(activityDisplayContainer) activityDisplayContainer.style.display = 'block';
                    if(btnExportActivityPdf) btnExportActivityPdf.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter as atividades da resposta da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        async function translateTextWithAI() {
            if (!sourceTextToTranslate || !sourceLanguageSelect || !targetLanguageSelect) {
                displayErrorMessage("Alguns elementos do formulário de tradução não foram encontrados."); return;
            }
            const textToTranslate = sourceTextToTranslate.value.trim();
            const sourceLang = sourceLanguageSelect.value;
            const targetLang = targetLanguageSelect.value;

            if (!textToTranslate) {
                displayErrorMessage("Por favor, introduza o texto que deseja traduzir.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A traduzir texto...");
            if(translatedTextContainer) translatedTextContainer.style.display = 'none';
            if(btnPlayTranslatedText) btnPlayTranslatedText.style.display = 'none';

            let translationPrompt = "";
            if (sourceLang === "auto") {
                translationPrompt = `Identifique a língua do seguinte texto e traduza-o para ${targetLanguageSelect.options[targetLanguageSelect.selectedIndex].text}. Não use formatação Markdown como asteriscos:\n\n"${textToTranslate}"`;
            } else {
                translationPrompt = `Traduza o seguinte texto de ${sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex].text} para ${targetLanguageSelect.options[targetLanguageSelect.selectedIndex].text}. Não use formatação Markdown como asteriscos:\n\n"${textToTranslate}"`;
            }

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: translationPrompt }] }],
                    generationConfig: { temperature: 0.3, maxOutputTokens: textToTranslate.length + 200 }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao traduzir (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const translatedText = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(translatedTextOutput) translatedTextOutput.textContent = translatedText;
                    if(translatedTextContainer) translatedTextContainer.style.display = 'block';
                    if(btnPlayTranslatedText) btnPlayTranslatedText.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter a tradução da resposta da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        async function gerarSlidesComIA() {
            if (!slideTopicInput || !slideNumSlidesInput || !slideIncludeImagesCheckbox || !slideTextSizeSelect || !slideTextToneSelect) {
                 displayErrorMessage("Alguns elementos do formulário de slides não foram encontrados."); return;
            }
            const topic = slideTopicInput.value.trim();
            const numSlides = slideNumSlidesInput.value;
            const includeImages = slideIncludeImagesCheckbox.checked;
            const textSize = slideTextSizeSelect.value;
            const textTone = slideTextToneSelect.value;


            if (!topic) {
                displayErrorMessage("Por favor, defina o tema principal dos slides.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar conteúdo dos slides...");
            if(slideContentContainer) slideContentContainer.style.display = 'none';
            if(btnExportSlidePdf) btnExportSlidePdf.style.display = 'none';
            if(btnExportSlidePptx) btnExportSlidePptx.style.display = 'none';

            let imagePromptInstruction = "";
            if (includeImages) {
                imagePromptInstruction = "Para cada slide, sugira também uma imagem relevante descrevendo-a brevemente entre colchetes, por exemplo: [Descrição da imagem sugerida].";
            }

            let lengthInstruction = "O conteúdo de cada slide deve ser de tamanho médio.";
            if (textSize === "conciso") lengthInstruction = "O conteúdo de cada slide deve ser conciso e direto ao ponto.";
            else if (textSize === "detalhado") lengthInstruction = "O conteúdo de cada slide deve ser detalhado e explicativo.";


            const prompt = `Crie o conteúdo para uma apresentação de aproximadamente ${numSlides} slides sobre o tema: "${topic}".
                Para cada slide, forneça um título claro e, em linhas separadas ou parágrafos curtos, os pontos principais do conteúdo.
                ${lengthInstruction} O tom do texto deve ser ${textTone}.
                ${imagePromptInstruction}
                Organize o conteúdo de forma lógica e progressiva.
                Formato esperado para cada slide:
                --- SLIDE X ---
                TÍTULO DO SLIDE
                Conteúdo do slide (em parágrafos ou bullet points curtos e separados por quebras de linha).
                ${includeImages ? "Sugestão de Imagem: [Descrição da imagem]" : ""}
                --- FIM SLIDE X ---
                Não use formatação Markdown como asteriscos. Certifique-se de que o conteúdo de cada slide seja distinto e não texto corrido sobreposto.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 3500 }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao gerar slides (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let slideContent = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    slideContent = slideContent.replace(/--- SLIDE (\d+) ---/g, "<h3>Slide $1</h3>")
                                             .replace(/--- FIM SLIDE \d+ ---/g, "<hr style='margin: 20px 0; border-color: var(--border-color);'>");

                    if(generatedSlideContent) generatedSlideContent.innerHTML = slideContent;
                    if(slideContentContainer) slideContentContainer.style.display = 'block';
                    if(btnExportSlidePdf) btnExportSlidePdf.style.display = 'inline-flex';
                    if(btnExportSlidePptx) btnExportSlidePptx.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter o conteúdo dos slides da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        async function gerarRelatorioComIA() {
            if (!reportTopicInput || !reportAuthorInput || !reportTextSizeSelect || !reportTextToneSelect) {
                displayErrorMessage("Alguns elementos do formulário de relatório não foram encontrados."); return;
            }
            const topic = reportTopicInput.value.trim();
            const author = reportAuthorInput.value.trim() || "Autor Desconhecido";
            const textSize = reportTextSizeSelect.value;
            const textTone = reportTextToneSelect.value;


            if (!topic) {
                displayErrorMessage("Por favor, defina o tema do relatório.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar estrutura do relatório...");
            if(reportContentContainer) reportContentContainer.style.display = 'none';
            if(btnExportReportPdf) btnExportReportPdf.style.display = 'none';

            let lengthInstruction = "O conteúdo do relatório deve ser de tamanho médio.";
            if (textSize === "resumido") lengthInstruction = "O conteúdo do relatório deve ser resumido e conciso.";
            else if (textSize === "detalhado") lengthInstruction = "O conteúdo do relatório deve ser detalhado e aprofundado.";


            const prompt = `Crie uma estrutura detalhada para um relatório sobre o tema "${topic}", com autoria de "${author}".
                O relatório deve ter um tom ${textTone} e ${lengthInstruction}
                Deve incluir as seguintes secções bem definidas:
                1.  Capa: Com título do relatório, autor(es), e data (usar a data atual no formato DD/MM/AAAA).
                2.  Sumário (apenas o título da secção, o conteúdo seria gerado após o desenvolvimento).
                3.  Introdução: Apresente o tema, a sua relevância, os objetivos do relatório e uma breve descrição da estrutura do trabalho.
                4.  Desenvolvimento: Divida esta secção em pelo menos 3 a 5 sub-secções com títulos claros e pertinentes ao tema. Para cada sub-secção, escreva parágrafos desenvolvendo a ideia principal.
                5.  Conclusão: Apresente as principais descobertas ou reflexões finais sobre o tema.
                6.  Referências Bibliográficas: Indique que esta secção listaria as fontes consultadas (deixe exemplos de como formatar referências no estilo ABNT ou APA).
                Formate o texto de forma clara e organizada, usando títulos e subtítulos apropriados. Não use formatação Markdown como asteriscos.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.6, maxOutputTokens: textSize === 'detalhado' ? 3500 : (textSize === 'médio' ? 3000 : 2000) }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao gerar relatório (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const reportContent = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(generatedReportContent) generatedReportContent.innerHTML = reportContent.replace(/\n/g, "<br>");
                    if(reportContentContainer) reportContentContainer.style.display = 'block';
                    if(btnExportReportPdf) btnExportReportPdf.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter a estrutura do relatório da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        let radimakChatHistory = [];
        async function enviarMensagemChatRadimak() {
            if (!chatInput || !chatMessagesContainer) {
                displayErrorMessage("Elementos do chat não foram encontrados."); return;
            }
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            appendMessageToChat("user", messageText);
            chatInput.value = "";

            if (!geminiFlashApiKey) {
                appendMessageToChat("radimak", "Desculpe, a API key para o Radimak não está configurada.");
                return;
            }
            showLoading("Radimak a pensar...");

            radimakChatHistory.push({ role: "user", parts: [{ text: messageText }] });

            try {
                const payload = {
                    contents: radimakChatHistory,
                    generationConfig: { temperature: 0.7, maxOutputTokens: 1000 }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API Radimak (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const radimakResponse = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    appendMessageToChat("radimak", radimakResponse);
                    radimakChatHistory.push({ role: "model", parts: [{ text: radimakResponse }] });
                } else {
                    appendMessageToChat("radimak", "Desculpe, não consegui processar a sua mensagem neste momento.");
                }
            } catch (error) {
                appendMessageToChat("radimak", `Ocorreu um erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function appendMessageToChat(sender, message) {
            if (!chatMessagesContainer) return;
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '10px';
            messageDiv.style.padding = '8px';
            messageDiv.style.borderRadius = '6px';
            messageDiv.style.wordWrap = 'break-word';

            if (sender === "user") {
                messageDiv.style.backgroundColor = "var(--primary-red)";
                messageDiv.style.color = "var(--light-text)";
                messageDiv.style.textAlign = "right";
                messageDiv.style.marginLeft = "auto";
                messageDiv.style.maxWidth = "70%";
            } else {
                messageDiv.style.backgroundColor = "#333";
                messageDiv.style.color = "var(--light-text)";
                messageDiv.style.textAlign = "left";
                messageDiv.style.marginRight = "auto";
                messageDiv.style.maxWidth = "70%";
            }
            messageDiv.textContent = message;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function exportSlidesToPptx() {
            if (!generatedSlideContent) { displayErrorMessage("Elemento de conteúdo dos slides não encontrado."); return; }
            const slideContentRawHTML = generatedSlideContent.innerHTML;
            if (!slideContentRawHTML || slideContentRawHTML.trim() === "") {
                displayErrorMessage("Não há conteúdo de slides para exportar.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar ficheiro PPTX...");

            try {
                if (typeof PptxGenJS === 'undefined') {
                    throw new Error("Biblioteca PptxGenJS não carregada. Não é possível exportar para PPTX.");
                }
                let pptx = new PptxGenJS();

                const slideSections = slideContentRawHTML.split(/<hr.*?>/i);

                slideSections.forEach((sectionHtml, slideIndex) => {
                    if (sectionHtml.trim() === "") return;

                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sectionHtml;

                    let title = `Slide ${slideIndex + 1}`;
                    const h3 = tempDiv.querySelector('h3');
                    if (h3) {
                        title = h3.textContent.replace(/Slide \d+:/i, '').trim() || title;
                        h3.remove();
                    }

                    let content = "";
                    const imageSuggestionMatch = tempDiv.innerText.match(/Sugestão de Imagem:\s*\[(.*?)\]/im);
                    let imageSuggestionText = imageSuggestionMatch ? `Sugestão de Imagem: ${imageSuggestionMatch[1]}` : null;

                    let mainContentText = tempDiv.innerText.replace(/Sugestão de Imagem:\s*\[.*?\]/im, '').trim();
                    content = mainContentText.split('\n').filter(line => line.trim() !== '').join('\n');


                    let slide = pptx.addSlide();
                    slide.background = { color: "1f1f1f" };

                    slide.addText(title, {
                        x: 0.5, y: 0.25, w: '90%', h: 0.75,
                        fontSize: 28, bold: true, color: "FFFFFF", align: 'center', valign: 'middle'
                    });

                    if (content) {
                        slide.addText(content, {
                            x: 0.5, y: 1.2, w: '90%', h: '70%',
                            fontSize: 16, color: "E0E0E0", align: 'left',
                            lineSpacing: 24,
                            bullet: true
                        });
                    }

                    if (imageSuggestionText) {
                        slide.addText(imageSuggestionText, {
                            x: 0.5, y: 5.0, w: '90%', h: 0.5,
                            fontSize: 10, italic: true, color: "A0A0A0", align: 'left'
                        });
                    }
                });


                if (pptx.slides.length === 0) {
                     throw new Error("Não foi possível analisar nenhum slide do conteúdo para gerar o PPTX.");
                }

                pptx.writeFile({ fileName: 'apresentacao_gerada.pptx' })
                    .then(() => console.log("Ficheiro PPTX gerado com sucesso."))
                    .catch(err => {
                        console.error("Erro ao gerar PPTX:", err);
                        displayErrorMessage("Erro ao gerar o ficheiro PPTX.");
                    });

            } catch (error) {
                console.error("Erro ao exportar para PPTX:", error);
                displayErrorMessage(`Erro ao exportar para PPTX: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const btnExportPptx = document.getElementById('btnExportSlidePptx');
            if(btnExportPptx) {
                btnExportPptx.addEventListener('click', exportSlidesToPptx);
            }
        });


        function exportTextToPdf(text, filename = "documento.pdf") {
            if (!text || text.trim() === "") {
                displayErrorMessage("Não há conteúdo para exportar para PDF.");
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    displayErrorMessage("Biblioteca jsPDF não carregada. Não é possível exportar para PDF.");
                    return;
                }
                const doc = new jsPDF();
                const margin = 15;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const usableWidth = pageWidth - 2 * margin;
                let y = margin;
                doc.setFontSize(12);
                doc.setTextColor(0,0,0);
                const textWithNewlines = text.replace(/<br\s*\/?>/gi, '\n').replace(/\*\*/g, '');
                const lines = doc.splitTextToSize(textWithNewlines, usableWidth);
                lines.forEach(line => {
                    if (y + 10 > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, margin, y);
                    y += 7;
                });
                doc.save(filename);
            } catch (error) {
                console.error("Erro ao exportar para PDF:", error);
                displayErrorMessage("Ocorreu um erro ao tentar exportar o documento para PDF.");
            }
        }


        async function gerarImagemComIA() {
            if (!imagePromptTextarea) { displayErrorMessage("Elemento de prompt da imagem não encontrado."); return; }
            const prompt = imagePromptTextarea.value.trim();
            if (!prompt) {
                displayErrorMessage("Por favor, descreva a imagem que deseja gerar.");
                return;
            }
            if (!imagenApiKey) {
                displayErrorMessage("A API key para o serviço de geração de imagem (Imagen) não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar imagem com IA, aguarde...");
            if(aiGeneratedImageElement) aiGeneratedImageElement.style.display = 'none';
            if(aiImagePlaceholder) {
                aiImagePlaceholder.style.display = 'block';
                aiImagePlaceholder.textContent = "A sua imagem gerada por IA aparecerá aqui.";
                aiImagePlaceholder.style.color = "#6c757d";
            }
            if(btnDownloadAiImage) btnDownloadAiImage.style.display = 'none';
            if(btnDeleteAiImage) btnDeleteAiImage.style.display = 'none';

            try {
                const payload = {
                    instances: [{ prompt: prompt }],
                    parameters: { "sampleCount": 1 }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${imagenApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro da API Imagen:", errorData);
                    let detailedErrorMessage = `Erro da API Imagen (${response.status}): ${response.statusText}.`;
                    if (errorData?.error?.message) {
                        detailedErrorMessage += ` Detalhes: ${errorData.error.message}`;
                        if (errorData.error.message.toLowerCase().includes("billed users") || errorData.error.message.toLowerCase().includes("billing")) {
                             detailedErrorMessage = "Erro: A API de geração de imagens (Imagen) requer uma conta Google Cloud com faturação ativa. Por favor, verifique as configurações da sua conta.";
                        } else if (errorData.error.message.toLowerCase().includes("api key not valid")) {
                            detailedErrorMessage = "Erro: A API key fornecida para a geração de imagens não é válida. Por favor, verifique a API key.";
                        }
                    }
                    throw new Error(detailedErrorMessage);
                }
                const result = await response.json();
                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    const base64ImageData = result.predictions[0].bytesBase64Encoded;
                    if(aiGeneratedImageElement) {
                        aiGeneratedImageElement.src = `data:image/png;base64,${base64ImageData}`;
                        aiGeneratedImageElement.style.display = 'block';
                    }
                    if(aiImagePlaceholder) aiImagePlaceholder.style.display = 'none';
                    if(btnDownloadAiImage) btnDownloadAiImage.style.display = 'inline-flex';
                    if(btnDeleteAiImage) btnDeleteAiImage.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter a imagem da resposta da API. A resposta pode não conter os dados esperados.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
                if(aiImagePlaceholder) {
                    aiImagePlaceholder.textContent = "Falha ao gerar imagem. Verifique a mensagem de erro acima.";
                    aiImagePlaceholder.style.color = "red";
                    aiImagePlaceholder.style.display = 'block';
                }
            } finally {
                hideLoading();
            }
        }

        function baixarImagemGeradaIA() {
            if (!aiGeneratedImageElement || !aiGeneratedImageElement.src || aiGeneratedImageElement.src.startsWith('#') || aiGeneratedImageElement.style.display === 'none') {
                displayErrorMessage("Nenhuma imagem gerada por IA para baixar.");
                return;
            }
            clearErrorMessage();
            try {
                const link = document.createElement('a');
                link.download = 'imagem_gerada_ia.png';
                link.href = aiGeneratedImageElement.src;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                displayErrorMessage("Ocorreu um erro ao tentar baixar a imagem da IA.");
            }
        }

        function apagarImagemGeradaIA() {
            if(aiGeneratedImageElement) {
                aiGeneratedImageElement.src = '#';
                aiGeneratedImageElement.style.display = 'none';
            }
            if(aiImagePlaceholder) {
                aiImagePlaceholder.textContent = "A sua imagem gerada por IA aparecerá aqui.";
                aiImagePlaceholder.style.color = "#6c757d";
                aiImagePlaceholder.style.display = 'block';
            }
            if(btnDownloadAiImage) btnDownloadAiImage.style.display = 'none';
            if(btnDeleteAiImage) btnDeleteAiImage.style.display = 'none';
            clearErrorMessage();
        }

        function parseAudioMimeType(mimeTypeString) {
            const params = { rate: 24000, bitsPerSample: 16, channels: 1 };
            if (!mimeTypeString) return params;
            const parts = mimeTypeString.toLowerCase().split(';');
            parts.forEach(part => {
                const [key, value] = part.trim().split('=');
                if (key === 'rate' && !isNaN(parseInt(value))) {
                    params.rate = parseInt(value);
                } else if (key.startsWith('audio/l') && !isNaN(parseInt(key.substring(7)))) {
                     params.bitsPerSample = parseInt(key.substring(7));
                } else if (key === 'channels' && !isNaN(parseInt(value))) {
                    params.channels = parseInt(value);
                }
            });
            if (parts[0].startsWith("audio/l")) {
                const bpsStr = parts[0].substring(7);
                if (!isNaN(parseInt(bpsStr))) {
                    params.bitsPerSample = parseInt(bpsStr);
                }
            }
            return params;
        }

        function convertPcmToWav(base64PcmData, originalMimeType) {
            console.log("A converter PCM para WAV. MimeType Original:", originalMimeType);
            const pcmData = Uint8Array.from(atob(base64PcmData), c => c.charCodeAt(0));
            const params = parseAudioMimeType(originalMimeType);
            const sampleRate = params.rate;
            const numChannels = params.channels;
            const bitsPerSample = params.bitsPerSample;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            new Uint8Array(buffer, 44).set(pcmData);
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function gerarFalaComIA(textToSpeak, sourceTitle = "Texto", isMultiSpeaker = false, voice1 = "Charon", voice2 = "Kore") {
            if (!textToSpeak || textToSpeak.trim() === "") {
                displayErrorMessage("Não há texto para converter em fala.");
                if(audioPlayerContainer) audioPlayerContainer.style.display = 'none';
                return;
            }
            if (!ttsApiKey) {
                displayErrorMessage("A API key para o serviço de Text-to-Speech (TTS) não está configurada.");
                if(audioPlayerContainer) audioPlayerContainer.style.display = 'none';
                return;
            }
            clearErrorMessage();
            showLoading(`A gerar fala para "${sourceTitle}", aguarde...`);
            if(audioPlayerContainer) audioPlayerContainer.style.display = 'none';

            try {
                const ttsModel = "gemini-1.5-flash-preview-tts";
                let speechConfigPayload = {};

                if (isMultiSpeaker) {
                    const speaker1Voice = document.getElementById('podcastSpeaker1Voice')?.value || voice1;
                    const speaker2Voice = document.getElementById('podcastSpeaker2Voice')?.value || voice2;
                    speechConfigPayload = {
                        multiSpeakerVoiceConfig: {
                            speakerVoiceConfigs: [
                                { speaker: "Speaker 1", voiceConfig: { prebuiltVoiceConfig: { voice_name: speaker1Voice } } },
                                { speaker: "Speaker 2", voiceConfig: { prebuiltVoiceConfig: { voice_name: speaker2Voice } } }
                            ]
                        }
                    };
                } else {
                     speechConfigPayload = {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voice_name: voice1 }
                        }
                    };
                }

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: textToSpeak.replace(/\*\*/g, '') }]
                    }],
                    generationConfig: {
                        response_modalities: ["audio"],
                        temperature: 0.7,
                        speechConfig: speechConfigPayload
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${ttsModel}:generateContent?key=${ttsApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro da API TTS:", errorData);
                    let detailedErrorMessage = `Erro da API TTS (${response.status}): ${response.statusText || 'Erro desconhecido'}.`;
                    if (errorData?.error?.message) {
                        detailedErrorMessage += ` Detalhes: ${errorData.error.message}`;
                         if (response.status === 429 || errorData.error.message.toLowerCase().includes("quota") || errorData.error.message.toLowerCase().includes("resource_exhausted")) {
                            detailedErrorMessage = "Erro: Excedeu a sua quota atual para o serviço TTS. Por favor, verifique o seu plano e detalhes de faturação ou tente novamente mais tarde.";
                             if (errorData.details) {
                                const helpLinkObj = errorData.details.find(d => d["@type"] === "type.googleapis.com/google.rpc.Help");
                                const helpLink = helpLinkObj?.links?.[0]?.url;
                                if (helpLink) {
                                    detailedErrorMessage += ` Consulte: ${helpLink}`;
                                }
                            }
                        } else if (response.status === 500 || errorData.error.message.toLowerCase().includes("internal error")) {
                            detailedErrorMessage = `Erro Interno do Servidor (500) ao contactar a API TTS. Por favor, tente novamente mais tarde. Se o problema persistir, reporte em https://developers.generativeai.google/guide/troubleshooting. (Detalhe API: ${errorData.error.message})`;
                        } else if (errorData.error.message.toLowerCase().includes("api key not valid")) {
                            detailedErrorMessage = "Erro: A API key fornecida para o serviço de TTS não é válida ou o modelo não está acessível com esta chave.";
                        } else if (errorData.error.message.toLowerCase().includes("billed users") || errorData.error.message.toLowerCase().includes("billing")) {
                             detailedErrorMessage = "Erro: A API de TTS pode requerer uma conta Google Cloud com faturação ativa.";
                        } else if (errorData.error.message.toLowerCase().includes("model not found") || errorData.error.message.toLowerCase().includes("is not supported") || errorData.error.message.toLowerCase().includes("voice name") ) {
                            detailedErrorMessage = `Erro: O modelo TTS ('${ttsModel}') ou a voz configurada não foram encontrados ou não são suportados. Verifique o nome do modelo, a voz e a documentação da API. (Detalhe API: ${errorData.error.message})`;
                        }
                    }
                    throw new Error(detailedErrorMessage);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const candidate = result.candidates[0];
                    if (candidate.finishReason !== "STOP") {
                         if (!candidate.content?.parts?.[0]?.inlineData?.data) {
                            let finishReasonMessage = `O modelo TTS não concluiu a geração com sucesso. Motivo: ${candidate.finishReason || 'Desconhecido'}. Não foi possível obter dados de áudio.`;
                            if (candidate.finishReason === "OTHER") {
                                console.error("Resposta completa da API (finishReason OTHER, sem dados de áudio):", JSON.stringify(result, null, 2));
                                finishReasonMessage += " Isto pode indicar um problema com o texto de entrada (demasiado longo, caracteres inválidos), uma instabilidade temporária da API, ou o modelo pode não ter conseguido gerar áudio para este pedido específico. Tente com um texto mais simples ou mais curto, ou aguarde um pouco e tente novamente.";
                            }
                            throw new Error(finishReasonMessage);
                         }
                         console.warn(`O modelo TTS terminou com o motivo: ${candidate.finishReason || 'Desconhecido'}. A tentar usar os dados de áudio se disponíveis.`);
                    }

                    if (candidate.content?.parts?.[0]?.inlineData?.data) {
                        let audioDataB64 = candidate.content.parts[0].inlineData.data;
                        let finalMimeType = candidate.content.parts[0].inlineData.mimeType || 'audio/L16;rate=24000';
                        lastAttemptedMimeType = finalMimeType;
                        console.log("Áudio recebido da API. MIME Type Original:", finalMimeType, "Tamanho (base64):", audioDataB64.length);
                        if (!audioDataB64.trim()) {
                            throw new Error("Os dados de áudio recebidos da API estão vazios.");
                        }
                        if (finalMimeType.toLowerCase().includes("audio/l16") ||
                            finalMimeType.toLowerCase().includes("audio/l24") ||
                            finalMimeType.toLowerCase().includes("audio/l32") ||
                            finalMimeType.toLowerCase().includes("pcm")) {
                            try {
                                audioDataB64 = convertPcmToWav(audioDataB64, finalMimeType);
                                finalMimeType = 'audio/wav';
                                lastAttemptedMimeType = finalMimeType;
                                console.log("Áudio convertido para WAV. Novo MIME Type:", finalMimeType);
                            } catch (conversionError) {
                                console.error("Erro ao converter PCM para WAV:", conversionError);
                                throw new Error(`Falha ao converter áudio PCM para WAV: ${conversionError.message}`);
                            }
                        }
                        if(audioPlayer) {
                            audioPlayer.src = `data:${finalMimeType};base64,${audioDataB64}`;
                            audioPlayer.onloadeddata = function() {
                                console.log("Dados do áudio carregados (onloadeddata).");
                                if(audioPlayerContainer) audioPlayerContainer.style.display = 'block';
                                audioPlayer.play().catch(playError => {
                                    console.error("Erro ao tentar reproduzir o áudio:", playError);
                                    displayErrorMessage("Erro ao iniciar a reprodução do áudio. Interação do utilizador pode ser necessária ou o formato de áudio pode não ser suportado.");
                                });
                            };
                            audioPlayer.load();
                            console.log("Fala gerada e src do áudio definido. A aguardar carregamento do áudio...");
                        }
                    } else {
                        console.error("Resposta da API TTS não contém dados de áudio válidos, mesmo com finishReason STOP (ou outro):", result);
                        throw new Error("Não foi possível obter os dados de áudio da resposta da API TTS. A estrutura da resposta pode estar incompleta.");
                    }
                } else {
                    console.error("Resposta inesperada da API TTS (sem candidatos):", result);
                    throw new Error("Resposta da API TTS não contém 'candidates'.");
                }
            } catch (error) {
                console.error("Erro ao gerar fala com IA:", error);
                displayErrorMessage(error.message);
                if(audioPlayerContainer) audioPlayerContainer.style.display = 'none';
            } finally {
                hideLoading();
            }
        }

        // Novas Funções
        async function gerarPlanejamentoDeAula() {
            if (!lessonPlanYearSelect || !lessonPlanSubjectSelect || !lessonPlanContentInput || !lessonPlanObjectivesInput || !lessonPlanDurationInput || !lessonPlanStyleSelect || !lessonPlanSizeSelect) {
                displayErrorMessage("Elementos do formulário de planejamento de aula não encontrados."); return;
            }
            const ano = lessonPlanYearSelect.options[lessonPlanYearSelect.selectedIndex].text;
            const materia = lessonPlanSubjectSelect.value;
            const conteudo = lessonPlanContentInput.value.trim();
            const objetivos = lessonPlanObjectivesInput.value.trim();
            const duracao = lessonPlanDurationInput.value.trim();
            const estilo = lessonPlanStyleSelect.value;
            const tamanho = lessonPlanSizeSelect.value;

            if (!conteudo || !objetivos || !duracao) {
                displayErrorMessage("Por favor, preencha todos os campos para o planejamento de aula.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar planejamento de aula...");
            if(lessonPlanDisplayContainer) lessonPlanDisplayContainer.style.display = 'none';
            if(btnExportLessonPlanPdf) btnExportLessonPlanPdf.style.display = 'none';

            const prompt = `Crie um plano de aula ${tamanho} para ${materia} - ${ano}, sobre o conteúdo "${conteudo}".
Objetivos da Aula: ${objetivos}.
Duração Estimada: ${duracao}.
Estilo da Aula: ${estilo}.
O plano deve incluir seções claras como: Introdução/Motivação, Desenvolvimento (com etapas/atividades), Recursos Necessários, Avaliação e Observações/Adaptações (se houver).
Não use formatação Markdown como asteriscos.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: tamanho === 'detalhado' ? 2000 : (tamanho === 'padrão' ? 1500 : 1000) }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao gerar planejamento (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const plan = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(generatedLessonPlanText) generatedLessonPlanText.textContent = plan;
                    if(lessonPlanDisplayContainer) lessonPlanDisplayContainer.style.display = 'block';
                    if(btnExportLessonPlanPdf) btnExportLessonPlanPdf.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter o planejamento da resposta da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        async function verificarAssunto() {
            if (!verifySubjectYearSelect || !verifySubjectSubjectSelect || !verifySubjectContentSelect) {
                displayErrorMessage("Elementos do formulário de verificação de assunto não encontrados."); return;
            }
            const ano = verifySubjectYearSelect.options[verifySubjectYearSelect.selectedIndex].text;
            const materia = verifySubjectSubjectSelect.value;
            const conteudo = verifySubjectContentSelect.value;

            if (!conteudo) {
                displayErrorMessage("Por favor, selecione o conteúdo para verificar.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading(`A verificar assunto: ${conteudo}...`);
            if(subjectVerificationDisplayContainer) subjectVerificationDisplayContainer.style.display = 'none';
            if(btnExportSubjectVerificationPdf) btnExportSubjectVerificationPdf.style.display = 'none';

            const prompt = `Forneça um resumo detalhado sobre o seguinte conteúdo de ${materia} para ${ano}: "${conteudo}".
Inclua:
- Definições chave.
- Principais teoremas ou propriedades (se aplicável à matéria e conteúdo).
- Axiomas relevantes (se aplicável).
- Exemplos práticos ou ilustrativos.
O texto deve ser claro, informativo e preciso. Não use formatação Markdown como asteriscos.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.5, maxOutputTokens: 2000 }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao verificar assunto (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const verification = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(verifiedSubjectText) verifiedSubjectText.textContent = verification;
                    if(subjectVerificationDisplayContainer) subjectVerificationDisplayContainer.style.display = 'block';
                    if(btnExportSubjectVerificationPdf) btnExportSubjectVerificationPdf.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter a verificação do assunto da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        async function gerarProva() {
            if (!proofInstitutionNameInput || !proofTeacherNameInput || !proofYearSelect || !proofSubjectSelect || !proofContentInput || !proofNumQuestionsSelect || !proofQuestionTypeSelect) {
                 displayErrorMessage("Elementos do formulário de geração de prova não encontrados."); return;
            }
            const institution = proofInstitutionNameInput.value.trim() || "Nome da Instituição";
            const teacher = proofTeacherNameInput.value.trim() || "Professor(a)";
            const ano = proofYearSelect.options[proofYearSelect.selectedIndex].text;
            const materia = proofSubjectSelect.value;
            const conteudos = proofContentInput.value.trim();
            const numQuestoes = proofNumQuestionsSelect.value;
            const tipoQuestao = proofQuestionTypeSelect.value;
            // const headerImageFile = proofHeaderImageInput.files[0]; // Funcionalidade futura

            if (!conteudos) {
                displayErrorMessage("Por favor, defina o(s) conteúdo(s) da prova.");
                return;
            }
            if (!geminiFlashApiKey) {
                displayErrorMessage("A API key para o serviço Gemini não está configurada.");
                return;
            }
            clearErrorMessage();
            showLoading("A gerar prova...");
            if(proofDisplayContainer) proofDisplayContainer.style.display = 'none';
            if(btnExportProofPdf) btnExportProofPdf.style.display = 'none';

            let tipoQuestaoPrompt = "";
            if (tipoQuestao === "Objetivas") {
                tipoQuestaoPrompt = "As questões devem ser exclusivamente objetivas (múltipla escolha com 4 alternativas A, B, C, D, ou Verdadeiro/Falso).";
            } else if (tipoQuestao === "Subjetivas") {
                tipoQuestaoPrompt = "As questões devem ser exclusivamente subjetivas (dissertativas, problemas para resolver, interpretação de texto).";
            } else { // Ambas
                tipoQuestaoPrompt = "As questões devem ser uma mistura de objetivas (múltipla escolha com 4 alternativas A, B, C, D, ou Verdadeiro/Falso) e subjetivas (dissertativas, problemas).";
            }

            const prompt = `Crie uma prova com ${numQuestoes} questões sobre ${materia} para ${ano}, cobrindo o(s) seguinte(s) conteúdo(s): "${conteudos}".
Instituição: ${institution}
Professor(a): ${teacher}
${tipoQuestaoPrompt}
As questões devem ser claras, bem formuladas e adequadas ao nível de ensino.
Para questões objetivas, indique a resposta correta entre parênteses no final, ex: (Resposta: C).
Formate o texto da prova de forma limpa, pronta para impressão, com um cabeçalho na primeira página contendo o nome da instituição, nome do professor, matéria, ano/série e um espaço para o nome do aluno e data.
Não use formatação Markdown como asteriscos ou negrito excessivo.`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.6, maxOutputTokens: 3000 }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiFlashApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API ao gerar prova (${response.status}): ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const proofText = result.candidates[0].content.parts[0].text.replace(/\*\*/g, '');
                    if(generatedProofText) generatedProofText.textContent = proofText;
                    if(proofDisplayContainer) proofDisplayContainer.style.display = 'block';
                    if(btnExportProofPdf) btnExportProofPdf.style.display = 'inline-flex';
                } else {
                    throw new Error("Não foi possível obter o conteúdo da prova da API.");
                }
            } catch (error) {
                displayErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

    </script>

</body>
</html>
